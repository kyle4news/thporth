<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Perspectives Admin - Add Manual Post</title>
   <style>
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }
      
       body {
           font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
           background: #0f0f0f;
           color: #e0e0e0;
           padding: 20px;
           max-width: 800px;
           margin: 0 auto;
       }
      
       h1 {
           color: #fff;
           margin-bottom: 30px;
           font-size: 24px;
       }
      
       .form-group {
           margin-bottom: 20px;
       }
      
       label {
           display: block;
           margin-bottom: 8px;
           color: #b0b0b0;
           font-size: 14px;
           font-weight: 500;
       }
      
       input[type="text"],
       textarea {
           width: 100%;
           padding: 12px;
           background: #1a1a1a;
           border: 1px solid #333;
           border-radius: 6px;
           color: #e0e0e0;
           font-size: 14px;
           font-family: inherit;
       }
      
       input[type="text"]:focus,
       textarea:focus {
           outline: none;
           border-color: #4a9eff;
       }
      
       .radio-group {
           display: flex;
           gap: 20px;
           margin-top: 8px;
       }
      
       .radio-option {
           display: flex;
           align-items: center;
           gap: 6px;
       }
      
       .radio-option input[type="radio"] {
           margin: 0;
       }
      
       button {
           background: #4a9eff;
           color: #fff;
           border: none;
           padding: 12px 24px;
           border-radius: 6px;
           font-size: 14px;
           font-weight: 500;
           cursor: pointer;
           transition: background 0.2s;
       }
      
       button:hover {
           background: #3a8eef;
       }
      
       button:disabled {
           background: #333;
           cursor: not-allowed;
           opacity: 0.6;
       }
      
       .status {
           margin-top: 20px;
           padding: 12px;
           border-radius: 6px;
           font-size: 14px;
           display: none;
       }
      
       .status.success {
           background: #1a3a1a;
           border: 1px solid #2a5a2a;
           color: #4ade80;
           display: block;
       }
      
       .status.error {
           background: #3a1a1a;
           border: 1px solid #5a2a2a;
           color: #f87171;
           display: block;
       }
      
       .info {
           background: #1a1a2a;
           border: 1px solid #2a2a3a;
           padding: 12px;
           border-radius: 6px;
           margin-bottom: 20px;
           font-size: 13px;
           color: #b0b0b0;
       }
      
       .info strong {
           color: #fff;
       }
      
       .platform-detected {
           margin-top: 8px;
           font-size: 12px;
           color: #4a9eff;
       }
   </style>
</head>
<body>
   <h1>Perspectives Admin - Add Manual Post</h1>
  
   <div class="info">
       <strong>How to use:</strong> Paste a social post URL (X/Twitter, YouTube, Mastodon) and select priority. The system will automatically detect the platform and extract the post ID.
   </div>
  
  
  
   <hr style="margin:24px 0;border:none;border-top:1px solid #222" />
   <h2 style="margin:12px 0 16px">Today's Games (from sportsGames)</h2>
   <div class="info">
       Click <strong>Load games</strong> to fetch today's games from Firestore; paste a social URL next to a game and click <strong>Add</strong>.<br/><br/>
       <strong>Recommended Order:</strong><br/>
       1. <strong>League Importance</strong> (optional) - Can be set at any time, independent of other fields<br/>
       2. <strong>Featured checkbox</strong> - Check this first to enable header text input (saves immediately)<br/>
       3. <strong>Header Text</strong> - Type your header text (auto-saves 500ms after you stop typing)<br/>
       4. <strong>"All" checkbox</strong> - Check this AFTER typing header text if you want it applied to all featured games in the league<br/><br/>
       <strong>Auto-save:</strong> Featured checkbox saves immediately. Header text and league importance auto-save 500ms after you stop typing (or when you press Enter/blur the field). Border colors indicate save status: blue = saving, green = saved, red = error.
   </div>
   <div style="margin:12px 0"><button id="loadGamesBtn" type="button">Load games</button></div>
   <div style="margin:12px 0">
       <label for="pasteList"><strong>OR</strong> Paste output from <code>list-games-simple.cjs</code> here (then click "Load pasted list")</label>
       <textarea id="pasteList" rows="8" style="width:100%;margin-top:8px" placeholder="Paste the script output here"></textarea>
       <div style="margin-top:8px"><button id="loadPastedBtn" type="button">Load pasted list</button></div>
   </div>
   <div id="gamesList" style="margin-top:12px"></div>


   <!-- Manual add form moved below games list -->
   <form id="addPostForm">
       <div class="form-group">
           <label for="gameId">Game ID *</label>
           <input type="text" id="gameId" name="gameId" required placeholder="e.g., 1234567890">
       </div>


       <div class="form-group">
           <label for="url">Social Post URL *</label>
           <input type="text" id="url" name="url" required placeholder="https://twitter.com/espn/status/1234567890">
           <div class="platform-detected" id="platformDetected"></div>
       </div>


       <div class="form-group">
           <label>Priority</label>
           <div class="radio-group">
               <div class="radio-option">
                   <input type="radio" id="priority-viral" name="priority" value="100" checked>
                   <label for="priority-viral">Viral (100)</label>
               </div>
               <div class="radio-option">
                   <input type="radio" id="priority-highlight" name="priority" value="75">
                   <label for="priority-highlight">Highlight (75)</label>
               </div>
               <div class="radio-option">
                   <input type="radio" id="priority-normal" name="priority" value="50">
                   <label for="priority-normal">Normal (50)</label>
               </div>
               <div class="radio-option">
                   <input type="radio" id="priority-low" name="priority" value="25">
                   <label for="priority-low">Low (25)</label>
               </div>
           </div>
       </div>


       <div class="form-group">
           <label>Source Type</label>
           <div class="radio-group">
               <div class="radio-option">
                   <input type="radio" id="source-fan" name="sourceType" value="fan" checked>
                   <label for="source-fan">Fan</label>
               </div>
               <div class="radio-option">
                   <input type="radio" id="source-official" name="sourceType" value="official">
                   <label for="source-official">Official</label>
               </div>
               <div class="radio-option">
                   <input type="radio" id="source-media" name="sourceType" value="media">
                   <label for="source-media">Media</label>
               </div>
           </div>
       </div>


       <div class="form-group">
           <label for="notes">Optional Notes</label>
           <textarea id="notes" name="notes" rows="3" placeholder="e.g., First angle replay from stands"></textarea>
       </div>


       <button type="submit" id="submitBtn">Add to Game</button>
   </form>


   <div class="status" id="status"></div>


   <script>
       const FUNCTION_URL = 'https://flashlive-scraper-124291936014.us-central1.run.app';
      
       // Firebase client initialization (re-use project config from main site)
       // This enables reading the `sportsGames` collection in Firestore.
       const firebaseConfig = {
           apiKey: "AIzaSyD3bw8d4q2oO2qpbgGiUG6Qnlf4aABK3Bc",
           authDomain: "flashlive-daily-scraper.firebaseapp.com",
           projectId: "flashlive-daily-scraper",
           storageBucket: "flashlive-daily-scraper.appspot.com",
           messagingSenderId: "124291936014",
           appId: "1:124291936014:web:acadcaa791d6046849315f"
       };


       // Load Firebase SDK (compat) dynamically if not present
       async function ensureFirebase() {
           if (window.firebase && window.firebase.firestore) return;
           await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
           await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js');
           if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
       }


       function loadScript(src) {
           return new Promise((resolve, reject) => {
               const s = document.createElement('script');
               s.src = src;
               s.onload = resolve;
               s.onerror = reject;
               document.head.appendChild(s);
           });
       }
       function detectPlatform(url) {
           if (url.includes('twitter.com') || url.includes('x.com')) return 'X/Twitter';
           if (url.includes('mastodon')) return 'Mastodon';
           if (url.includes('youtube.com') || url.includes('youtu.be')) return 'YouTube';
           if (url.includes('instagram.com')) return 'Instagram';
           return 'Unknown';
       }
      
       document.getElementById('url').addEventListener('input', (e) => {
           const url = e.target.value;
           const platformDetected = document.getElementById('platformDetected');
           if (url) {
               const platform = detectPlatform(url);
               platformDetected.textContent = `Platform detected: ${platform}`;
           } else {
               platformDetected.textContent = '';
           }
       });
      
       document.getElementById('addPostForm').addEventListener('submit', async (e) => {
           e.preventDefault();
          
           const submitBtn = document.getElementById('submitBtn');
           const status = document.getElementById('status');
          
           submitBtn.disabled = true;
           status.className = 'status';
           status.textContent = 'Adding post...';
          
           const formData = {
               gameId: document.getElementById('gameId').value.trim(),
               url: document.getElementById('url').value.trim(),
               priority: parseInt(document.querySelector('input[name="priority"]:checked').value),
               sourceType: document.querySelector('input[name="sourceType"]:checked').value,
               addedBy: 'admin',
               notes: document.getElementById('notes').value.trim() || null
           };
          
           try {
               const response = await fetch(`${FUNCTION_URL}/perspectives/addManualPost`, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json'
                   },
                   body: JSON.stringify(formData)
               });
              
               let data;
               try {
                   data = await response.json();
               } catch (jsonError) {
                   // If response isn't JSON, get text
                   const text = await response.text();
                   throw new Error(`Server returned non-JSON: ${text.substring(0, 200)}`);
               }
              
               if (response.ok) {
                   status.className = 'status success';
                   status.textContent = `✅ Success! Post added: ${data.post?.id || 'unknown'}`;
                   document.getElementById('addPostForm').reset();
                   document.getElementById('platformDetected').textContent = '';
               } else {
                   throw new Error(data.details || data.error || `HTTP ${response.status}: ${response.statusText}`);
               }
           } catch (error) {
               status.className = 'status error';
               let errorMsg = error.message;
               if (error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
                   errorMsg = `Network error: Could not reach Cloud Function. Make sure the function is deployed and the URL is correct. Details: ${error.message}`;
               }
               status.textContent = `❌ Error: ${errorMsg}`;
               console.error('Full error:', error);
           } finally {
               submitBtn.disabled = false;
           }
       });


      // Hardcoded_Today_Schedules data structure (same as index.html)
      const Hardcoded_Today_Schedules = {
          'Tennis': [
              { date: '2026-01-19', away: 'Australian Open', home: '2nd Round', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-20', away: 'Australian Open', home: '2nd Round', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-21', away: 'Australian Open', home: '2nd Round', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-22', away: 'Australian Open', home: '2nd, 3rd Rd', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-23', away: 'Australian Open', home: '3rd Round', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-24', away: 'Australian Open', home: '4th Round', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-25', away: 'Australian Open', home: '4th Round', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-26', away: 'Australian Open', home: 'Quarterfinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-27', away: 'Australian Open', home: 'Quarterfinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-28', away: 'Australian Open', home: 'Semifinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-29', away: 'Australian Open', home: 'Semifinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-30', away: 'Women\'s Final', home: 'Semifinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
              { date: '2026-01-31', away: 'Men\'s Final', home: 'Semifinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
          ],
          // Add more leagues here as needed: Boxing, UFC, PGATour, LPGATour, PGATourChampions, NASCARCupSeries, DPWorldTour, LIVGolf
      };

      // ----- New: Load games from Firestore and render list with URL inputs -----
      document.getElementById('loadGamesBtn').addEventListener('click', async () => {
          const btn = document.getElementById('loadGamesBtn');
          btn.disabled = true; btn.textContent = 'Loading...';
          try {
              await ensureFirebase();
              const db = firebase.firestore();
              const gamesRef = db.collection('artifacts/flashlive-daily-scraper/public/data/sportsGames');


              // Compute today's date in America/New_York as YYYY-MM-DD
              const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });


              const snapshot = await gamesRef.where('gameDate', '==', todayStr).orderBy('Start Time').get();
              let games = snapshot.empty ? [] : snapshot.docs.map(d => d.data());
              
              // Add hardcoded games from Hardcoded_Today_Schedules
              const leaguesWithHardcodedToday = ['Boxing', 'UFC', 'PGATour', 'LPGATour', 'Tennis', 'PGATourChampions', 'NASCARCupSeries', 'DPWorldTour', 'LIVGolf'];
              const leagueDisplayNameMap = {
                  'Boxing': 'Boxing',
                  'UFC': 'UFC',
                  'PGATour': 'PGA Tour',
                  'LPGATour': 'LPGA Tour',
                  'Tennis': 'Tennis',
                  'PGATourChampions': 'PGA Champions',
                  'NASCARCupSeries': 'NASCAR Cup Series',
                  'DPWorldTour': 'DP World Tour',
                  'LIVGolf': 'LIV Golf'
              };
              
              leaguesWithHardcodedToday.forEach((leagueKey, leagueIndex) => {
                  const leagueDisplayName = leagueDisplayNameMap[leagueKey] || leagueKey;
                  
                  if (Hardcoded_Today_Schedules[leagueKey]) {
                      const todayGames = Hardcoded_Today_Schedules[leagueKey].filter(game => game.date === todayStr);
                      
                      todayGames.forEach((game, gameIndex) => {
                          // Create Game ID: hardcoded-{leagueKey}-{date}-{index}
                          const gameId = `hardcoded-${leagueKey}-${game.date}-${gameIndex}`;
                          
                          // Convert to same format as regular games
                          games.push({
                              'Game ID': gameId,
                              'Away Team': game.away,
                              'Home Team': game.home,
                              'League': leagueDisplayName,
                              'Sport': leagueKey === 'Tennis' ? 'Tennis' : (leagueKey.includes('Golf') ? 'Golf' : (leagueKey.includes('PGA') ? 'Golf' : (leagueKey === 'Boxing' || leagueKey === 'UFC' ? 'Combat' : 'Racing'))),
                              'Match Status': 'SCHEDULED',
                              'gameDate': game.date,
                              'channel': game.channel || '',
                              'Channel': game.channel || '',
                              'hardcodedTodayUrl': game.url || '',
                              'isHardcoded': true, // Flag to identify hardcoded games
                              'Start Time': null // Hardcoded games don't have start times
                          });
                      });
                  }
              });


               // Load featured games to check which ones are already featured and get header text
               const featuredRef = db.collection('artifacts/flashlive-daily-scraper/public/data/Featured');
               const featuredSnapshot = await featuredRef.where('gameDate', '==', todayStr).get();
               const featuredGameIds = new Set();
               const featuredGameData = new Map(); // Map of gameId -> {headerText, applyToAllLeague}
               const leagueImportanceMap = new Map(); // Map of league -> leagueImportance
               featuredSnapshot.forEach(doc => {
                   const data = doc.data();
                   const gameId = data['Game ID'] || data.gameId;
                   const league = data.League || data.league;
                   if (gameId) {
                       featuredGameIds.add(String(gameId));
                       featuredGameData.set(String(gameId), {
                           headerText: data.headerText || data['Header Text'] || '',
                           applyToAllLeague: data.applyToAllLeague || data['Apply To All League'] || false
                       });
                   }
                   // Track league importance (use first non-null value found for each league)
                   if (league && !leagueImportanceMap.has(league)) {
                       const importance = data.leagueImportance !== null && data.leagueImportance !== undefined 
                           ? data.leagueImportance 
                           : (data['League Importance'] !== null && data['League Importance'] !== undefined ? data['League Importance'] : null);
                       if (importance !== null) {
                           leagueImportanceMap.set(league, Number(importance));
                       }
                   }
               });


               renderGamesList(games, featuredGameIds, todayStr, featuredGameData, leagueImportanceMap);
           } catch (err) {
               console.error('Error loading games:', err);
               alert('Failed to load games: ' + err.message);
           } finally {
               btn.disabled = false; btn.textContent = 'Load games';
           }
       });


       function renderGamesList(games, featuredGameIds = new Set(), gameDate = null, featuredGameData = new Map(), leagueImportanceMap = new Map()) {
           const container = document.getElementById('gamesList');
           container.innerHTML = '';
           if (!games || games.length === 0) {
               container.innerHTML = '<div class="info">No games found for today.</div>';
               return;
           }


           // If gameDate not provided, compute today's date
           if (!gameDate) {
               gameDate = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
           }


           // Group games by league
           const byLeague = {};
           games.forEach(game => {
               const league = game.League || game.league || 'Unknown League';
               if (!byLeague[league]) byLeague[league] = [];
               byLeague[league].push(game);
           });


           const leagueNames = Object.keys(byLeague).sort();


           leagueNames.forEach(league => {
               const section = document.createElement('div');
               section.style.marginBottom = '18px';


               const header = document.createElement('div');
               header.style.display = 'flex';
               header.style.alignItems = 'baseline';
               header.style.justifyContent = 'space-between';
               header.style.marginBottom = '8px';


               const title = document.createElement('div');
               title.innerHTML = `<strong style="font-size:15px">${escapeHtml(league)}</strong>`;
               header.appendChild(title);


               const headerRight = document.createElement('div');
               headerRight.style.display = 'flex';
               headerRight.style.alignItems = 'center';
               headerRight.style.gap = '12px';

               // League importance input
               const importanceWrap = document.createElement('div');
               importanceWrap.style.display = 'flex';
               importanceWrap.style.alignItems = 'center';
               importanceWrap.style.gap = '6px';
               
               const importanceLabel = document.createElement('label');
               importanceLabel.textContent = 'League importance:';
               importanceLabel.style.fontSize = '12px';
               importanceLabel.style.color = '#9aa';
               importanceLabel.style.marginBottom = '0';
               
               const importanceInput = document.createElement('input');
               importanceInput.type = 'number';
               importanceInput.min = '1';
               importanceInput.max = '99';
               importanceInput.placeholder = '1-99';
               importanceInput.style.width = '60px';
               importanceInput.style.padding = '4px 6px';
               importanceInput.style.background = '#1a1a1a';
               importanceInput.style.border = '1px solid #333';
               importanceInput.style.borderRadius = '4px';
               importanceInput.style.color = '#e0e0e0';
               importanceInput.style.fontSize = '12px';
               const currentImportance = leagueImportanceMap.get(league);
               if (currentImportance !== undefined && currentImportance !== null) {
                   importanceInput.value = String(currentImportance);
               }
               
              // Save league importance when changed (debounced)
              let importanceTimeout = null;
              let isSavingImportance = false;
              const saveLeagueImportance = async () => {
                  clearTimeout(importanceTimeout);
                  importanceTimeout = setTimeout(async () => {
                      if (isSavingImportance) return; // Prevent concurrent saves
                      isSavingImportance = true;
                      
                      const importanceValue = importanceInput.value.trim();
                      const importanceNum = importanceValue === '' ? null : Number(importanceValue);
                      
                      if (importanceValue !== '' && (isNaN(importanceNum) || importanceNum < 1 || importanceNum > 99)) {
                          alert('League importance must be a number between 1 and 99');
                          importanceInput.value = currentImportance !== undefined && currentImportance !== null ? String(currentImportance) : '';
                          isSavingImportance = false;
                          return;
                      }
                      
                      // Visual feedback: show saving state
                      const originalBorder = importanceInput.style.border;
                      importanceInput.style.border = '1px solid #4a9eff';
                      
                      try {
                          const response = await fetch(`${FUNCTION_URL}/perspectives/updateLeagueImportance`, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json'
                              },
                              body: JSON.stringify({
                                  league: league,
                                  gameDate: gameDate,
                                  leagueImportance: importanceNum
                              })
                          });
                          
                          if (!response.ok) {
                              const data = await response.json().catch(() => ({ error: 'Unknown error' }));
                              throw new Error(data.error || data.details || `HTTP ${response.status}`);
                          }
                          
                          const data = await response.json();
                          console.log(`Updated league importance for ${league}:`, data);
                          
                          // Update the map for future renders
                          if (importanceNum !== null) {
                              leagueImportanceMap.set(league, importanceNum);
                          } else {
                              leagueImportanceMap.delete(league);
                          }
                          
                          // Success: briefly show green border
                          importanceInput.style.border = '1px solid #4ade80';
                          setTimeout(() => {
                              importanceInput.style.border = originalBorder;
                          }, 500);
                      } catch (err) {
                          console.error('Error saving league importance:', err);
                          alert('Error saving league importance: ' + err.message);
                          importanceInput.value = currentImportance !== undefined && currentImportance !== null ? String(currentImportance) : '';
                          // Error: show red border
                          importanceInput.style.border = '1px solid #f87171';
                          setTimeout(() => {
                              importanceInput.style.border = originalBorder;
                          }, 2000);
                      } finally {
                          isSavingImportance = false;
                      }
                  }, 500); // Debounce 500ms
              };
               
               importanceInput.addEventListener('blur', saveLeagueImportance);
               importanceInput.addEventListener('keypress', (e) => {
                   if (e.key === 'Enter') {
                       importanceInput.blur();
                   }
               });
               
               importanceWrap.appendChild(importanceLabel);
               importanceWrap.appendChild(importanceInput);
               headerRight.appendChild(importanceWrap);

               const count = document.createElement('div');
               count.style.color = '#9aa';
               count.style.fontSize = '13px';
               count.textContent = `${byLeague[league].length} game${byLeague[league].length !== 1 ? 's' : ''}`;
               headerRight.appendChild(count);
               
               header.appendChild(headerRight);


               section.appendChild(header);


               // divider
               const hr = document.createElement('div');
               hr.style.height = '1px';
               hr.style.background = '#222';
               hr.style.margin = '6px 0 12px 0';
               section.appendChild(hr);


               // Column headers row
               const headerRow = document.createElement('div');
               headerRow.style.display = 'grid';
               headerRow.style.gridTemplateColumns = '60px 1fr 200px 80px 420px 120px';
               headerRow.style.gap = '8px';
               headerRow.style.alignItems = 'center';
               headerRow.style.marginBottom = '8px';
               headerRow.style.paddingBottom = '8px';
               headerRow.style.borderBottom = '1px solid #333';
              
               const featuredHeader = document.createElement('div');
               featuredHeader.style.fontSize = '12px';
               featuredHeader.style.fontWeight = '600';
               featuredHeader.style.color = '#9aa';
               featuredHeader.textContent = 'Featured';
              
               const gameInfoHeader = document.createElement('div');
               gameInfoHeader.style.fontSize = '12px';
               gameInfoHeader.style.fontWeight = '600';
               gameInfoHeader.style.color = '#9aa';
               gameInfoHeader.textContent = 'Game';
              
               const headerTextHeader = document.createElement('div');
               headerTextHeader.style.fontSize = '12px';
               headerTextHeader.style.fontWeight = '600';
               headerTextHeader.style.color = '#9aa';
               headerTextHeader.textContent = 'Header Text';
              
               const applyToAllHeader = document.createElement('div');
               applyToAllHeader.style.fontSize = '12px';
               applyToAllHeader.style.fontWeight = '600';
               applyToAllHeader.style.color = '#9aa';
               applyToAllHeader.textContent = 'All League';
              
               const urlHeader = document.createElement('div');
               urlHeader.style.fontSize = '12px';
               urlHeader.style.fontWeight = '600';
               urlHeader.style.color = '#9aa';
               urlHeader.textContent = 'Social URL';
              
               const actionHeader = document.createElement('div');
               actionHeader.style.fontSize = '12px';
               actionHeader.style.fontWeight = '600';
               actionHeader.style.color = '#9aa';
               actionHeader.textContent = 'Action';
              
               headerRow.appendChild(featuredHeader);
               headerRow.appendChild(gameInfoHeader);
               headerRow.appendChild(headerTextHeader);
               headerRow.appendChild(applyToAllHeader);
               headerRow.appendChild(urlHeader);
               headerRow.appendChild(actionHeader);
               section.appendChild(headerRow);


               // games list for league
               byLeague[league].forEach(game => {
                   const row = document.createElement('div');
                   row.style.display = 'grid';
                   row.style.gridTemplateColumns = '60px 1fr 200px 80px 420px 120px';
                   row.style.gap = '8px';
                   row.style.alignItems = 'center';
                   row.style.marginBottom = '8px';


                   const gameId = String(game['Game ID'] || game.gameId || 'NO-ID');
                   const isFeatured = featuredGameIds.has(gameId);
                   const gameData = featuredGameData.get(gameId) || { headerText: '', applyToAllLeague: false };


                   // Featured checkbox
                   const featuredWrap = document.createElement('div');
                   const featuredCheckbox = document.createElement('input');
                   featuredCheckbox.type = 'checkbox';
                   featuredCheckbox.checked = isFeatured;
                   featuredCheckbox.style.cursor = 'pointer';
                   featuredCheckbox.style.width = '18px';
                   featuredCheckbox.style.height = '18px';
                   featuredWrap.appendChild(featuredCheckbox);
                   featuredWrap.style.display = 'flex';
                   featuredWrap.style.justifyContent = 'center';


                   const gameInfo = document.createElement('div');
                   const startTime = game['Start Time'] ? new Date(game['Start Time']).toLocaleString() : '';
                   const isHardcoded = game.isHardcoded === true;
                   const hardcodedLabel = isHardcoded ? '<span style="color:#ffa500;font-size:11px;font-weight:600;">[Hardcoded]</span> ' : '';
                   gameInfo.innerHTML = `<div style="font-size:13px;color:#9aa">${hardcodedLabel}<code style="color:#cfc">${escapeHtml(String(gameId))}</code></div><div style="margin-top:6px"><strong>${escapeHtml(game['Away Team'] || '')}</strong> @ <strong>${escapeHtml(game['Home Team'] || '')}</strong></div><div style="margin-top:6px;font-size:12px;color:#b0b0b0">${escapeHtml(startTime || 'No start time')}</div>`;


                   // Header Text input and checkbox
                   const headerTextWrap = document.createElement('div');
                   headerTextWrap.style.display = 'flex';
                   headerTextWrap.style.flexDirection = 'column';
                   headerTextWrap.style.gap = '4px';
                  
                   const headerTextInput = document.createElement('input');
                   headerTextInput.type = 'text';
                   headerTextInput.placeholder = 'Header text (optional)';
                   headerTextInput.value = gameData.headerText || '';
                   headerTextInput.style.width = '100%';
                   headerTextInput.style.padding = '6px';
                   headerTextInput.style.background = '#1a1a1a';
                   headerTextInput.style.border = '1px solid #333';
                   headerTextInput.style.borderRadius = '4px';
                   headerTextInput.style.color = '#e0e0e0';
                   headerTextInput.style.fontSize = '12px';
                   headerTextInput.disabled = !isFeatured; // Only enable if featured
                  
                   const applyToAllWrap = document.createElement('div');
                   applyToAllWrap.style.display = 'flex';
                   applyToAllWrap.style.alignItems = 'center';
                   applyToAllWrap.style.gap = '4px';
                  
                   const applyToAllCheckbox = document.createElement('input');
                   applyToAllCheckbox.type = 'checkbox';
                   applyToAllCheckbox.checked = gameData.applyToAllLeague || false;
                   applyToAllCheckbox.disabled = !isFeatured; // Only enable if featured
                   applyToAllCheckbox.style.cursor = isFeatured ? 'pointer' : 'not-allowed';
                   applyToAllCheckbox.style.width = '14px';
                   applyToAllCheckbox.style.height = '14px';
                  
                   const applyToAllLabel = document.createElement('label');
                   applyToAllLabel.textContent = 'All';
                   applyToAllLabel.style.fontSize = '11px';
                   applyToAllLabel.style.color = isFeatured ? '#b0b0b0' : '#666';
                   applyToAllLabel.style.cursor = isFeatured ? 'pointer' : 'not-allowed';
                  
                   applyToAllWrap.appendChild(applyToAllCheckbox);
                   applyToAllWrap.appendChild(applyToAllLabel);
                   headerTextWrap.appendChild(headerTextInput);
                   headerTextWrap.appendChild(applyToAllWrap);
                  
                  // Save header text when it changes (debounced)
                  let headerTextTimeout = null;
                  let isSavingHeader = false;
                  const saveHeaderText = async () => {
                      // Check current checkbox state, not the closure variable
                      if (!featuredCheckbox.checked) return;
                      
                      clearTimeout(headerTextTimeout);
                      headerTextTimeout = setTimeout(async () => {
                          if (isSavingHeader) return; // Prevent concurrent saves
                          isSavingHeader = true;
                          
                          // Visual feedback: show saving state
                          const originalBorder = headerTextInput.style.border;
                          headerTextInput.style.border = '1px solid #4a9eff';
                          
                          try {
                              const response = await fetch(`${FUNCTION_URL}/perspectives/updateFeaturedHeader`, {
                                  method: 'POST',
                                  headers: {
                                      'Content-Type': 'application/json'
                                  },
                                  body: JSON.stringify({
                                      gameId: gameId,
                                      gameDate: gameDate,
                                      headerText: headerTextInput.value.trim(),
                                      applyToAllLeague: applyToAllCheckbox.checked
                                  })
                              });
                              
                              if (!response.ok) {
                                  const data = await response.json().catch(() => ({ error: 'Unknown error' }));
                                  console.error('Error saving header text:', data.error || data.details);
                                  headerTextInput.style.border = '1px solid #f87171'; // Red on error
                                  setTimeout(() => {
                                      headerTextInput.style.border = originalBorder;
                                  }, 2000);
                              } else {
                                  // Success: briefly show green border
                                  headerTextInput.style.border = '1px solid #4ade80';
                                  setTimeout(() => {
                                      headerTextInput.style.border = originalBorder;
                                  }, 500);
                              }
                          } catch (err) {
                              console.error('Error saving header text:', err);
                              headerTextInput.style.border = '1px solid #f87171'; // Red on error
                              setTimeout(() => {
                                  headerTextInput.style.border = originalBorder;
                              }, 2000);
                          } finally {
                              isSavingHeader = false;
                          }
                      }, 500); // Debounce 500ms
                  };
                  
                  headerTextInput.addEventListener('input', saveHeaderText);
                  applyToAllCheckbox.addEventListener('change', saveHeaderText);
                  
                   // Store reference to update enabled state when featured checkbox changes
                   const updateHeaderTextEnabled = () => {
                       const isNowFeatured = featuredCheckbox.checked;
                       headerTextInput.disabled = !isNowFeatured;
                       applyToAllCheckbox.disabled = !isNowFeatured;
                       applyToAllLabel.style.color = isNowFeatured ? '#b0b0b0' : '#666';
                       applyToAllLabel.style.cursor = isNowFeatured ? 'pointer' : 'not-allowed';
                   };
                  
                   // Wrap the featured checkbox change handler
                   const originalHandler = featuredCheckbox.onchange;
                   featuredCheckbox.onchange = null; // Clear to avoid conflicts
                   featuredCheckbox.addEventListener('change', async function() {
                       updateHeaderTextEnabled();
                       // Call original handler logic inline
                       await (async () => {
                           featuredCheckbox.disabled = true;
                           try {
                               const response = await fetch(`${FUNCTION_URL}/perspectives/toggleFeatured`, {
                                   method: 'POST',
                                   headers: {
                                       'Content-Type': 'application/json'
                                   },
                                   body: JSON.stringify({
                                       gameId: gameId,
                                       gameDate: gameDate,
                                       featured: featuredCheckbox.checked
                                   })
                               });


                               let data;
                               try {
                                   data = await response.json();
                               } catch (jsonError) {
                                   const text = await response.text();
                                   throw new Error(`Server returned non-JSON: ${text.substring(0, 200)}`);
                               }


                              if (response.ok) {
                                  if (featuredCheckbox.checked) {
                                      featuredGameIds.add(gameId);
                                      // If header text was already entered, save it now
                                      if (headerTextInput.value.trim()) {
                                          saveHeaderText();
                                      }
                                  } else {
                                      featuredGameIds.delete(gameId);
                                      // Clear header text when unfeatured
                                      headerTextInput.value = '';
                                      applyToAllCheckbox.checked = false;
                                  }
                              } else {
                                  throw new Error(data.error || data.details || `HTTP ${response.status}: ${response.statusText}`);
                              }
                           } catch (err) {
                               console.error('Error updating featured status:', err);
                               let errorMsg = err.message;
                              
                               if (err.message.includes('Failed to fetch') || err.message.includes('Load failed')) {
                                   errorMsg = `Network error: Could not reach Cloud Function. Make sure the function is deployed with the new /perspectives/toggleFeatured endpoint. Details: ${err.message}`;
                               }
                              
                               alert('Error updating featured status: ' + errorMsg);
                               featuredCheckbox.checked = !featuredCheckbox.checked; // Revert checkbox
                               updateHeaderTextEnabled();
                           } finally {
                               featuredCheckbox.disabled = false;
                           }
                       })();
                   });
                  
                   updateHeaderTextEnabled(); // Set initial state


                   const inputWrap = document.createElement('div');
                   const input = document.createElement('input');
                   input.type = 'text';
                   input.placeholder = 'Paste social URL here';
                   input.style.width = '100%';
                   inputWrap.appendChild(input);


                   const btnWrap = document.createElement('div');
                   const addBtn = document.createElement('button');
                   addBtn.type = 'button';
                   addBtn.textContent = 'Add';
                   addBtn.addEventListener('click', async () => {
                       addBtn.disabled = true;
                       try {
                           const url = input.value.trim();
                           if (!url) { alert('Please paste a social URL'); return; }
                           const payload = {
                               gameId: String(game['Game ID'] || game.gameId),
                               url: url,
                               priority: 50,
                               sourceType: 'fan',
                               addedBy: 'admin'
                           };


                           const resp = await fetch(`${FUNCTION_URL}/perspectives/addManualPost`, {
                               method: 'POST',
                               headers: { 'Content-Type': 'application/json' },
                               body: JSON.stringify(payload)
                           });
                           const data = await (resp.headers.get('content-type')?.includes('application/json') ? resp.json() : resp.text());
                           if (!resp.ok) throw new Error(typeof data === 'string' ? data : (data.error || JSON.stringify(data)));
                           alert('Added post to game ' + payload.gameId);
                           input.value = '';
                       } catch (err) {
                           console.error(err);
                           alert('Error adding post: ' + err.message);
                       } finally {
                           addBtn.disabled = false;
                       }
                   });
                   btnWrap.appendChild(addBtn);


                   row.appendChild(featuredWrap);
                   row.appendChild(gameInfo);
                   row.appendChild(headerTextWrap);
                   row.appendChild(inputWrap);
                   row.appendChild(btnWrap);
                   section.appendChild(row);
               });


               container.appendChild(section);
           });
       }


       function escapeHtml(s) {
           if (!s) return '';
           return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
       }


       // ----- Parse pasted output from list-games-simple.cjs -----
       document.getElementById('loadPastedBtn').addEventListener('click', async () => {
           const text = document.getElementById('pasteList').value || '';
           if (!text.trim()) { alert('Paste the script output first'); return; }
           const parsed = parsePastedList(text);
           if (!parsed || parsed.length === 0) { alert('No games parsed from pasted text'); return; }
          
           // Load featured games to check which ones are already featured
           try {
               await ensureFirebase();
               const db = firebase.firestore();
               const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
               const featuredRef = db.collection('artifacts/flashlive-daily-scraper/public/data/Featured');
               const featuredSnapshot = await featuredRef.where('gameDate', '==', todayStr).get();
               const featuredGameIds = new Set();
               const featuredGameData = new Map();
               const leagueImportanceMap = new Map();
               featuredSnapshot.forEach(doc => {
                   const data = doc.data();
                   const gameId = data['Game ID'] || data.gameId;
                   const league = data.League || data.league;
                   if (gameId) {
                       featuredGameIds.add(String(gameId));
                       featuredGameData.set(String(gameId), {
                           headerText: data.headerText || data['Header Text'] || '',
                           applyToAllLeague: data.applyToAllLeague || data['Apply To All League'] || false
                       });
                   }
                   // Track league importance (use first non-null value found for each league)
                   if (league && !leagueImportanceMap.has(league)) {
                       const importance = data.leagueImportance !== null && data.leagueImportance !== undefined 
                           ? data.leagueImportance 
                           : (data['League Importance'] !== null && data['League Importance'] !== undefined ? data['League Importance'] : null);
                       if (importance !== null) {
                           leagueImportanceMap.set(league, Number(importance));
                       }
                   }
               });
               renderGamesList(parsed, featuredGameIds, todayStr, featuredGameData, leagueImportanceMap);
           } catch (err) {
               console.error('Error loading featured status:', err);
               // Still render the list even if we can't load featured status
               renderGamesList(parsed, new Set(), null, new Map(), new Map());
           }
       });


       function parsePastedList(text) {
           const lines = text.split(/\r?\n/).map(l => l.trimRight());
           const games = [];
           let currentLeague = '';
           const gameLineRe = /^\s*(\S+)\s+(.+?)\s+vs\s+(.+?)(?:\s+\(([^)]*)\))?\s*\[.*\]$/i;
           for (const raw of lines) {
               const line = raw.trim();
               if (!line) continue;
               if (/^-{3,}$/.test(line)) continue; // divider
               // league header likely has no 'vs' and not starting with id
               if (!line.includes(' vs ')) {
                   // treat as league header
                   currentLeague = line;
                   continue;
               }
               const m = line.match(gameLineRe);
               if (m) {
                   const gameId = m[1];
                   const away = m[2].trim();
                   const home = m[3].trim();
                   const timeOrScore = m[4] || '';
                   // Build minimal game objects compatible with renderer
                   games.push({
                       'Game ID': gameId,
                       'Away Team': away,
                       'Home Team': home,
                       'Start Time': timeOrScore || '',
                       'League': currentLeague || ''
                   });
               } else {
                   // fallback: try splitting by multiple spaces, take first token as id
                   const parts = line.split(/\s{2,}/);
                   if (parts.length >= 2 && parts[0].includes('-')) {
                       const id = parts[0].trim();
                       const teams = parts[1];
                       const vsIdx = teams.indexOf(' vs ');
                       if (vsIdx !== -1) {
                           const away = teams.slice(0, vsIdx).trim();
                           const home = teams.slice(vsIdx + 4).trim();
                           games.push({ 'Game ID': id, 'Away Team': away, 'Home Team': home, 'Start Time': '', 'League': currentLeague || '' });
                       }
                   }
               }
           }
           return games;
       }
   </script>
</body>
</html>





