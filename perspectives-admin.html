<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perspectives Admin - Add Manual Post</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
    
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
          background: #0f0f0f;
          color: #e0e0e0;
          padding: 20px;
          max-width: 800px;
          margin: 0 auto;
      }
    
      h1 {
          color: #fff;
          margin-bottom: 30px;
          font-size: 24px;
      }
    
      .form-group {
          margin-bottom: 20px;
      }
    
      label {
          display: block;
          margin-bottom: 8px;
          color: #b0b0b0;
          font-size: 14px;
          font-weight: 500;
      }
    
      input[type="text"],
      textarea {
          width: 100%;
          padding: 12px;
          background: #1a1a1a;
          border: 1px solid #333;
          border-radius: 6px;
          color: #e0e0e0;
          font-size: 14px;
          font-family: inherit;
      }
    
      input[type="text"]:focus,
      textarea:focus {
          outline: none;
          border-color: #4a9eff;
      }
    
      .radio-group {
          display: flex;
          gap: 20px;
          margin-top: 8px;
      }
    
      .radio-option {
          display: flex;
          align-items: center;
          gap: 6px;
      }
    
      .radio-option input[type="radio"] {
          margin: 0;
      }
    
      button {
          background: #4a9eff;
          color: #fff;
          border: none;
          padding: 12px 24px;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: background 0.2s;
      }
    
      button:hover {
          background: #3a8eef;
      }
    
      button:disabled {
          background: #333;
          cursor: not-allowed;
          opacity: 0.6;
      }
    
      .status {
          margin-top: 20px;
          padding: 12px;
          border-radius: 6px;
          font-size: 14px;
          display: none;
      }
    
      .status.success {
          background: #1a3a1a;
          border: 1px solid #2a5a2a;
          color: #4ade80;
          display: block;
      }
    
      .status.error {
          background: #3a1a1a;
          border: 1px solid #5a2a2a;
          color: #f87171;
          display: block;
      }
    
      .info {
          background: #1a1a2a;
          border: 1px solid #2a2a3a;
          padding: 12px;
          border-radius: 6px;
          margin-bottom: 20px;
          font-size: 13px;
          color: #b0b0b0;
      }
    
      .info strong {
          color: #fff;
      }
    
      .platform-detected {
          margin-top: 8px;
          font-size: 12px;
          color: #4a9eff;
      }
  </style>
</head>
<body>
  <h1>Perspectives Admin - Add Manual Post</h1>
   <div class="info">
      <strong>How to use:</strong> Paste a social post URL (X/Twitter, YouTube, Mastodon) and select priority. The system will automatically detect the platform and extract the post ID.
  </div>
 
   <hr style="margin:24px 0;border:none;border-top:1px solid #222" />
  <h2 style="margin:12px 0 16px">Games (from sportsGames / sportsGamesFuture)</h2>
  <div class="info">
      Select a date to edit featured games. Click <strong>Load games</strong> to fetch games for the selected date; paste a social URL next to a game and click <strong>Add</strong>.<br/><br/>
      <strong>Recommended Order:</strong><br/>
      1. <strong>League Importance</strong> (optional) - Can be set at any time, independent of other fields<br/>
      2. <strong>Featured checkbox</strong> - Check this first to enable header text input (saves immediately)<br/>
      3. <strong>Header Text</strong> - Type your header text (auto-saves 500ms after you stop typing)<br/>
      4. <strong>"All" checkbox</strong> - Check this AFTER typing header text if you want it applied to all featured games in the league<br/><br/>
      <strong>Auto-save:</strong> Featured checkbox saves immediately. Header text and league importance auto-save 500ms after you stop typing (or when you press Enter/blur the field). Border colors indicate save status: blue = saving, green = saved, red = error.
  </div>
  <div style="margin:12px 0">
      <label for="dateSelector" style="display:block;margin-bottom:8px;color:#b0b0b0;font-size:14px;font-weight:500">Select Date:</label>
      <select id="dateSelector" style="padding:8px 12px;background:#1a1a1a;border:1px solid #333;border-radius:6px;color:#e0e0e0;font-size:14px;font-family:inherit;margin-right:12px">
          <option value="today">Today</option>
          <option value="tomorrow">Tomorrow</option>
          <option value="+2">+2 Days</option>
          <option value="+3">+3 Days</option>
          <option value="+4">+4 Days</option>
          <option value="+5">+5 Days</option>
          <option value="+6">+6 Days</option>
      </select>
      <span id="selectedDateDisplay" style="color:#9aa;font-size:13px"></span>
  </div>
  <div style="margin:12px 0"><button id="loadGamesBtn" type="button">Load games</button></div>
  <div style="margin:12px 0">
      <label for="pasteList"><strong>OR</strong> Paste output from <code>list-games-simple.cjs</code> here (then click "Load pasted list")</label>
      <textarea id="pasteList" rows="8" style="width:100%;margin-top:8px" placeholder="Paste the script output here"></textarea>
      <div style="margin-top:8px"><button id="loadPastedBtn" type="button">Load pasted list</button></div>
  </div>
  <div id="gamesList" style="margin-top:12px"></div>




  <!-- Manual add form moved below games list -->
  <form id="addPostForm">
      <div class="form-group">
          <label for="gameId">Game ID *</label>
          <input type="text" id="gameId" name="gameId" required placeholder="e.g., 1234567890">
      </div>




      <div class="form-group">
          <label for="url">Social Post URL *</label>
          <input type="text" id="url" name="url" required placeholder="https://twitter.com/espn/status/1234567890">
          <div class="platform-detected" id="platformDetected"></div>
      </div>




      <div class="form-group">
          <label>Priority</label>
          <div class="radio-group">
              <div class="radio-option">
                  <input type="radio" id="priority-viral" name="priority" value="100" checked>
                  <label for="priority-viral">Viral (100)</label>
              </div>
              <div class="radio-option">
                  <input type="radio" id="priority-highlight" name="priority" value="75">
                  <label for="priority-highlight">Highlight (75)</label>
              </div>
              <div class="radio-option">
                  <input type="radio" id="priority-normal" name="priority" value="50">
                  <label for="priority-normal">Normal (50)</label>
              </div>
              <div class="radio-option">
                  <input type="radio" id="priority-low" name="priority" value="25">
                  <label for="priority-low">Low (25)</label>
              </div>
          </div>
      </div>




      <div class="form-group">
          <label>Source Type</label>
          <div class="radio-group">
              <div class="radio-option">
                  <input type="radio" id="source-fan" name="sourceType" value="fan" checked>
                  <label for="source-fan">Fan</label>
              </div>
              <div class="radio-option">
                  <input type="radio" id="source-official" name="sourceType" value="official">
                  <label for="source-official">Official</label>
              </div>
              <div class="radio-option">
                  <input type="radio" id="source-media" name="sourceType" value="media">
                  <label for="source-media">Media</label>
              </div>
          </div>
      </div>




      <div class="form-group">
          <label for="notes">Optional Notes</label>
          <textarea id="notes" name="notes" rows="3" placeholder="e.g., First angle replay from stands"></textarea>
      </div>




      <button type="submit" id="submitBtn">Add to Game</button>
  </form>




  <div class="status" id="status"></div>




  <script>
      const FUNCTION_URL = 'https://flashlive-scraper-124291936014.us-central1.run.app';
    
      // Firebase client initialization (re-use project config from main site)
      // This enables reading the `sportsGames` collection in Firestore.
      const firebaseConfig = {
          apiKey: "AIzaSyD3bw8d4q2oO2qpbgGiUG6Qnlf4aABK3Bc",
          authDomain: "flashlive-daily-scraper.firebaseapp.com",
          projectId: "flashlive-daily-scraper",
          storageBucket: "flashlive-daily-scraper.appspot.com",
          messagingSenderId: "124291936014",
          appId: "1:124291936014:web:acadcaa791d6046849315f"
      };


      // Date selector functionality
      function getSelectedDate() {
          const today = new Date();
          const todayInEST = new Date(today.toLocaleString('en-US', { timeZone: 'America/New_York' }));
          const selector = document.getElementById('dateSelector');
          const value = selector.value;
         
          if (value === 'today') {
              return todayInEST.toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
          } else if (value === 'tomorrow') {
              const tomorrow = new Date(todayInEST);
              tomorrow.setDate(tomorrow.getDate() + 1);
              return tomorrow.toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
          } else if (value.startsWith('+')) {
              const days = parseInt(value.substring(1)) || 0;
              const futureDate = new Date(todayInEST);
              futureDate.setDate(futureDate.getDate() + days);
              return futureDate.toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
          }
          return todayInEST.toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
      }


      function updateDateDisplay() {
          const selectedDate = getSelectedDate();
          const display = document.getElementById('selectedDateDisplay');
          const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
          if (selectedDate === todayStr) {
              display.textContent = `(Setting featured for ${selectedDate} - Today)`;
          } else {
              display.textContent = `(Setting featured for ${selectedDate})`;
          }
      }


      // Initialize date selector
      document.addEventListener('DOMContentLoaded', () => {
          updateDateDisplay();
          document.getElementById('dateSelector').addEventListener('change', updateDateDisplay);
      });




      // Load Firebase SDK (compat) dynamically if not present
      async function ensureFirebase() {
          if (window.firebase && window.firebase.firestore) return;
          await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
          await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js');
          if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      }




      function loadScript(src) {
          return new Promise((resolve, reject) => {
              const s = document.createElement('script');
              s.src = src;
              s.onload = resolve;
              s.onerror = reject;
              document.head.appendChild(s);
          });
      }
      function detectPlatform(url) {
          if (url.includes('twitter.com') || url.includes('x.com')) return 'X/Twitter';
          if (url.includes('mastodon')) return 'Mastodon';
          if (url.includes('youtube.com') || url.includes('youtu.be')) return 'YouTube';
          if (url.includes('instagram.com')) return 'Instagram';
          return 'Unknown';
      }
    
      document.getElementById('url').addEventListener('input', (e) => {
          const url = e.target.value;
          const platformDetected = document.getElementById('platformDetected');
          if (url) {
              const platform = detectPlatform(url);
              platformDetected.textContent = `Platform detected: ${platform}`;
          } else {
              platformDetected.textContent = '';
          }
      });
    
      document.getElementById('addPostForm').addEventListener('submit', async (e) => {
          e.preventDefault();
        
          const submitBtn = document.getElementById('submitBtn');
          const status = document.getElementById('status');
        
          submitBtn.disabled = true;
          status.className = 'status';
          status.textContent = 'Adding post...';
        
          const formData = {
              gameId: document.getElementById('gameId').value.trim(),
              url: document.getElementById('url').value.trim(),
              priority: parseInt(document.querySelector('input[name="priority"]:checked').value),
              sourceType: document.querySelector('input[name="sourceType"]:checked').value,
              addedBy: 'admin',
              notes: document.getElementById('notes').value.trim() || null
          };
        
          try {
              const response = await fetch(`${FUNCTION_URL}/perspectives/addManualPost`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(formData)
              });
            
              let data;
              try {
                  data = await response.json();
              } catch (jsonError) {
                  // If response isn't JSON, get text
                  const text = await response.text();
                  throw new Error(`Server returned non-JSON: ${text.substring(0, 200)}`);
              }
            
              if (response.ok) {
                  status.className = 'status success';
                  status.textContent = `✅ Success! Post added: ${data.post?.id || 'unknown'}`;
                  document.getElementById('addPostForm').reset();
                  document.getElementById('platformDetected').textContent = '';
              } else {
                  throw new Error(data.details || data.error || `HTTP ${response.status}: ${response.statusText}`);
              }
          } catch (error) {
              status.className = 'status error';
              let errorMsg = error.message;
              if (error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
                  errorMsg = `Network error: Could not reach Cloud Function. Make sure the function is deployed and the URL is correct. Details: ${error.message}`;
              }
              status.textContent = `❌ Error: ${errorMsg}`;
              console.error('Full error:', error);
          } finally {
              submitBtn.disabled = false;
          }
      });




     // Hardcoded_Today_Schedules data structure (same as index.html)
     const Hardcoded_Today_Schedules = {
        'CFB': [
{ date: '2026-01-27', time: '7:00 pm', startTime: '19:00', endTime: '22:00', away: 'East-West', home: 'Shrine Bowl', channel: 'NFL Network', url: 'https://x.com/ShrineBowl' },

],

'Tennis': [

{ date: '2026-01-27', time: '7:00 pm', startTime: '19:00', endTime: '23:59', away: 'Australian Open', home: 'Quarterfinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },

{ date: '2026-01-28', time: '7:00 pm', startTime: '19:00', endTime: '23:59', away: 'Australian Open', home: 'Quarterfinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },

{ date: '2026-01-29', time: '12:00 am', startTime: '00:00', endTime: '7:30', away: 'Australian Open', home: 'Semifinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },

{ date: '2026-01-29', time: '7:00 pm', startTime: '19:00', endTime: '23:59', away: 'Australian Open', home: 'Semifinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },

{ date: '2026-01-30', time: '12:00 am', startTime: '00:00', endTime: '7:00', away: 'Australian Open', home: 'Semifinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },

{ date: '2026-01-30', time: '8:00 pm', startTime: '20:00', endTime: '23:59', away: 'Australian Open', home: 'Semifinals', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },

{ date: '2026-01-31', time: '12:00 am', startTime: '00:00', endTime: '7:30', away: 'Australian Open', home: 'Women\'s Final', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },

{ date: '2026-01-31', time: '8:00 pm', startTime: '20:00', endTime: '23:59', away: 'Australian Open', home: '', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },

{ date: '2026-02-01', time: '12:00 am', startTime: '00:00', endTime: '7:30', away: 'Australian Open', home: 'Men\'s Final', channel: 'ESPN networks', url: 'https://www.espn.com/tennis/scoreboard/tournament/_/eventId/154-2026' },
 ],

    'PGATour': [
    { date: '2026-01-22', time: '11:30 am', startTime: '11:30', endTime: '17:15', home: 'The AMEX', away: 'First Round', channel: 'ESPN+, GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-01-23', time: '11:30 am', startTime: '11:30', endTime: '17:15', home: 'The AMEX', away: 'Second Round', channel: 'ESPN+, GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-01-24', time: '11:30 am', startTime: '11:30', endTime: '17:30', home: 'The AMEX', away: 'Third Round', channel: 'ESPN+, GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-01-25', time: '11:30 am', startTime: '11:30', endTime: '17:30', home: 'The AMEX', away: 'Final Round', channel: 'ESPN+, GOLF', url: 'https://www.pgatour.com/leaderboard' },

  { date: '2026-01-29', time: '3:00 pm', startTime: '15:00', endTime: '20:45', home: 'Farmers', away: 'First Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-01-30', time: '3:00 pm', startTime: '15:00', endTime: '20:45', home: 'Farmers', away: 'Second Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-01-31', time: '3:00 pm', startTime: '15:00', endTime: '21:00', home: 'Farmers', away: 'Third Round', channel: 'CBS', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-01', time: '3:00 pm', startTime: '15:00', endTime: '21:00', home: 'Farmers', away: 'Final Round', channel: 'CBS', url: 'https://www.pgatour.com/leaderboard' },

  { date: '2026-02-05', time: '1:00 pm', startTime: '13:00', endTime: '18:45', home: 'Phoenix Open', away: 'First Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-06', time: '1:00 pm', startTime: '13:00', endTime: '18:45', home: 'Phoenix Open', away: 'Second Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-07', time: '1:00 pm', startTime: '13:00', endTime: '19:00', home: 'Phoenix Open', away: 'Third Round', channel: 'CBS', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-08', time: '1:00 pm', startTime: '13:00', endTime: '19:00', home: 'Phoenix Open', away: 'Final Round', channel: 'CBS', url: 'https://www.pgatour.com/leaderboard' },

  { date: '2026-02-12', time: '12:00 pm', startTime: '12:00', endTime: '17:45', home: 'Pebble Beach', away: 'First Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-13', time: '12:00 pm', startTime: '12:00', endTime: '17:45', home: 'Pebble Beach', away: 'Second Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-14', time: '12:00 pm', startTime: '12:00', endTime: '18:00', home: 'Pebble Beach', away: 'Third Round', channel: 'CBS', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-15', time: '12:00 pm', startTime: '12:00', endTime: '18:00', home: 'Pebble Beach', away: 'Final Round', channel: 'CBS', url: 'https://www.pgatour.com/leaderboard' },

  { date: '2026-02-19', time: '1:00 pm', startTime: '13:00', endTime: '18:45', home: 'Genesis', away: 'First Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-20', time: '1:00 pm', startTime: '13:00', endTime: '18:45', home: 'Genesis', away: 'Second Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-21', time: '12:00 pm', startTime: '12:00', endTime: '18:00', home: 'Genesis', away: 'Third Round', channel: 'CBS', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-22', time: '12:00 pm', startTime: '12:00', endTime: '18:00', home: 'Genesis', away: 'Final Round', channel: 'CBS', url: 'https://www.pgatour.com/leaderboard' },

  { date: '2026-02-26', time: '', startTime: '', endTime: '', home: 'Cognizant', away: 'First Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-27', time: '', startTime: '', endTime: '', home: 'Cognizant', away: 'Second Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-02-28', time: '3:00 pm', startTime: '15:00', endTime: '21:00', home: 'Cognizant', away: 'Third Round', channel: 'NBC', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-03-01', time: '3:00 pm', startTime: '15:00', endTime: '21:00', home: 'Cognizant', away: 'Final Round', channel: 'NBC', url: 'https://www.pgatour.com/leaderboard' },

  { date: '2026-03-05', time: '2:00 pm', startTime: '14:00', endTime: '19:45', home: 'Arnold Palmer', away: 'First Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-03-06', time: '2:00 pm', startTime: '14:00', endTime: '19:45', home: 'Arnold Palmer', away: 'Second Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-03-07', time: '2:30 pm', startTime: '14:30', endTime: '20:30', home: 'Arnold Palmer', away: 'Third Round', channel: 'NBC', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-03-08', time: '2:30 pm', startTime: '14:30', endTime: '20:30', home: 'Arnold Palmer', away: 'Final Round', channel: 'NBC', url: 'https://www.pgatour.com/leaderboard' },

  { date: '2026-03-12', time: '1:00 pm', startTime: '13:00', endTime: '18:45', home: 'THE PLAYERS', away: 'First Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-03-13', time: '1:00 pm', startTime: '13:00', endTime: '18:45', home: 'THE PLAYERS', away: 'Second Round', channel: 'GOLF', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-03-14', time: '2:00 pm', startTime: '14:00', endTime: '20:00', home: 'THE PLAYERS', away: 'Third Round', channel: 'NBC', url: 'https://www.pgatour.com/leaderboard' },
  { date: '2026-03-15', time: '1:00 pm', startTime: '13:00', endTime: '19:00', home: 'THE PLAYERS', away: 'Final Round', channel: 'NBC', url: 'https://www.pgatour.com/leaderboard' },
],

'UFC': [
  { date: '2026-01-24', time: '5:00 PM', startTime: '17:00', endTime: '19:00', home: 'Gaethje-Pimblett', away: 'UFC 324 Early Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-324' },
  { date: '2026-01-24', time: '7:00 PM', startTime: '19:00', endTime: '21:00', home: 'Gaethje-Pimblett', away: 'UFC 324 Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-324' },
  { date: '2026-01-24', time: '9:00 PM', startTime: '21:00', endTime: '23:59', home: 'Gaethje-Pimblett', away: 'UFC 324 Main Card', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-324' },

  { date: '2026-01-31', time: '5:00 PM', startTime: '17:00', endTime: '19:00', home: 'Volkanovski-Lopes 2', away: 'UFC 325 Early Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-325' },
  { date: '2026-01-31', time: '7:00 PM', startTime: '19:00', endTime: '21:00', home: 'Volkanovski-Lopes 2', away: 'UFC 325 Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-325' },
  { date: '2026-01-31', time: '9:00 PM', startTime: '21:00', endTime: '23:59', home: 'Volkanovski-Lopes 2', away: 'UFC 325 Main Card', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-325' },

  { date: '2026-02-07', time: '6:00 PM', startTime: '18:00', endTime: '20:00', home: 'Bautista-Oliveira', away: 'UFC Fight Night Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-fight-night-february-07-2026' },
  { date: '2026-02-07', time: '9:00 PM', startTime: '21:00', endTime: '23:59', home: 'Bautista-Oliveira', away: 'UFC Fight Night Main Card', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-fight-night-february-07-2026' },

  { date: '2026-02-21', time: '5:00 PM', startTime: '17:00', endTime: '19:00', home: 'Strickland-Hernandez', away: 'UFC Fight Night Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-fight-night-february-21-2026' },
  { date: '2026-02-21', time: '8:00 PM', startTime: '20:00', endTime: '23:30', home: 'Strickland-Hernandez', away: 'UFC Fight Night Main Card', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-fight-night-february-21-2026' },

  { date: '2026-02-28', time: '6:00 PM', startTime: '18:00', endTime: '20:00', home: 'Moreno-Almabayev', away: 'UFC Fight Night Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-fight-night-february-28-2026' },
  { date: '2026-02-28', time: '9:00 PM', startTime: '21:00', endTime: '23:59', home: 'Moreno-Almabayev', away: 'UFC Fight Night Main Card', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-fight-night-february-28-2026' },

  { date: '2026-03-07', time: '5:00 PM', startTime: '17:00', endTime: '19:00', home: 'Holloway-Oliveira 2', away: 'UFC 326 Early Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-326' },
  { date: '2026-03-07', time: '7:00 PM', startTime: '19:00', endTime: '21:00', home: 'Holloway-Oliveira 2', away: 'UFC 326 Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-326' },
  { date: '2026-03-07', time: '9:00 PM', startTime: '21:00', endTime: '23:59', home: 'Holloway-Oliveira 2', away: 'UFC 326 Main Card', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-326' },

  { date: '2026-03-14', time: '6:00 PM', startTime: '18:00', endTime: '20:00', home: 'Emmett-Vallejos', away: 'UFC Fight Night Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-fight-night-march-14-2026' },
  { date: '2026-03-14', time: '9:00 PM', startTime: '21:00', endTime: '23:59', home: 'Emmett-Vallejos', away: 'UFC Fight Night Main Card', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-fight-night-march-14-2026' },

  { date: '2026-03-21', time: '1:00 PM', startTime: '13:00', endTime: '15:00', home: 'TBA-TBA', away: 'UFC Fight Night Prelims', channel: 'Paramount+' },
  { date: '2026-03-21', time: '4:00 PM', startTime: '16:00', endTime: '19:30', home: 'TBA-TBA', away: 'UFC Fight Night Main Card', channel: 'Paramount+' },

  { date: '2026-03-28', time: '6:00 PM', startTime: '18:00', endTime: '20:00', home: 'Adesanya-Pyfer', away: 'UFC Fight Night Prelims', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-fight-night-march-28-2026' },
  { date: '2026-03-28', time: '9:00 PM', startTime: '21:00', endTime: '23:59', home: 'Adesanya-Pyfer', away: 'UFC Fight Night Main Card', channel: 'Paramount+', url: 'https://www.ufc.com/event/ufc-fight-night-march-28-2026' }
],

'Boxing': [
{ date: '2026-01-23', time: '7:00 PM', home: 'Sanchez', away: 'Rubio', channel: 'DAZN', startTime: '19:00', endTime: '23:30' },
  { date: '2026-01-23', time: '9:00 PM', home: 'Walsh', away: 'Ocampo', channel: 'Paramount+', startTime: '21:00', endTime: '23:59' },
  { date: '2026-01-24', time: '8:00 PM', home: 'Muratalla', away: 'Cruz', channel: 'DAZN', startTime: '20:00', endTime: '23:59' },
  { date: '2026-01-30', time: '6:00 PM', home: 'Flores', away: 'Castillo', channel: 'ProBox TV', startTime: '18:00', endTime: '22:30' },
  { date: '2026-01-31', time: '12:00 AM', home: 'Zayas', away: 'Baraou', channel: '', startTime: '00:00', endTime: '23:59' },
  { date: '2026-01-31', time: '1:00 PM', home: 'Murtazaliev', away: 'Kelly', channel: 'DAZN', startTime: '13:00', endTime: '17:30' },
  { date: '2026-01-31', time: '8:00 PM', home: 'Lopez', away: 'Stevenson', channel: 'DAZN', startTime: '20:00', endTime: '23:59' },
  { date: '2026-01-31', time: '12:00 AM', home: 'Azim', away: 'Lemos', channel: 'BBC Two', startTime: '00:00', endTime: '23:59' },
  { date: '2026-01-31', time: '12:00 AM', home: 'Scull', away: 'Bank', channel: 'DAZN', startTime: '00:00', endTime: '23:59' },
  { date: '2026-02-05', time: '6:30 PM', home: 'Ramirez', away: 'Richards', channel: 'Punchinggrace.com', startTime: '18:30', endTime: '23:00' },
  { date: '2026-02-06', time: '9:00 PM', home: 'Medina', away: 'Curiel', channel: 'DAZN', startTime: '21:00', endTime: '23:59' },
  { date: '2026-02-07', time: '2:00 PM', home: 'Ball', away: 'Figueroa', channel: 'DAZN', startTime: '14:00', endTime: '18:30' },
  { date: '2026-02-10', time: '8:00 PM', home: 'Pagan', away: 'Jimenez', channel: 'DAZN', startTime: '20:00', endTime: '23:59' },
  { date: '2026-02-14', time: '12:00 AM', home: 'Ajagba', away: 'Martin', channel: 'Paramount+', startTime: '00:00', endTime: '23:59' },
  { date: '2026-02-15', time: '12:00 AM', home: 'Nishida', away: 'Mercado', channel: '', startTime: '00:00', endTime: '23:59' },
  { date: '2026-02-15', time: '12:00 PM', home: 'Muxanga', away: 'Byfield', channel: 'DAZN', startTime: '12:00', endTime: '16:30' },
  { date: '2026-02-21', time: '1:00 PM', home: 'Wood', away: 'Warrington', channel: 'DAZN', startTime: '13:00', endTime: '17:30' },
  { date: '2026-02-21', time: '12:00 AM', home: 'Santillan', away: 'Cepeda', channel: '', startTime: '00:00', endTime: '23:59' },
  { date: '2026-02-21', time: '7:00 PM', home: 'Barrios', away: 'Garcia', channel: 'DAZN', startTime: '19:00', endTime: '23:30' },
  { date: '2026-02-22', time: '8:00 PM', home: 'Shields', away: 'Crews-Dezurn', channel: 'DAZN', startTime: '20:00', endTime: '23:59' },
  { date: '2026-02-28', time: '4:00 PM', home: 'Nunez', away: 'Navarrete', channel: 'DAZN', startTime: '16:00', endTime: '20:30' },
  { date: '2026-02-28', time: '5:00 PM', home: 'Pierce', away: 'Parra', channel: 'Amazon Prime', startTime: '17:00', endTime: '21:30' },
  { date: '2026-02-28', time: '2:00 PM', home: 'Ursu', away: 'Cooper', channel: 'DAZN', startTime: '14:00', endTime: '18:30' },
  { date: '2026-03-05', time: '12:00 AM', home: 'Butler', away: 'Hiseni', channel: 'Punchinggrace.com', startTime: '00:00', endTime: '23:59' },
  { date: '2026-03-14', time: '3:00 PM', home: 'Dickens', away: 'Cacace', channel: 'DAZN', startTime: '15:00', endTime: '19:30' },
  { date: '2026-03-28', time: '1:45 PM', home: 'Itauma', away: 'Franklin', channel: 'DAZN', startTime: '13:45', endTime: '18:15' },
  { date: '2026-04-18', time: '12:00 AM', home: 'Adams', away: 'Agyarko', channel: '', startTime: '00:00', endTime: '23:59' }


],

'NASCARCupSeries': [
{ date: '2026-02-01', time: '8:00 PM', home: 'Clash at Bowman Gray', away: 'Bowman Gray', channel: 'FOX', startTime: '20:00', endTime: '23:59', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-02-12', time: '7:00 PM', home: 'Duel #1', away: 'Daytona', channel: 'FS1', startTime: '19:00', endTime: '23:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-02-12', time: '8:45 PM', home: 'Duel #2', away: 'Daytona', channel: 'FS1', startTime: '20:45', endTime: '23:59', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-02-15', time: '2:30 PM', home: 'Daytona 500', away: '', channel: 'FOX', startTime: '14:30', endTime: '19:00', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-02-22', time: '3:00 PM', home: 'Atlanta', away: '', channel: 'FOX', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-03-01', time: '3:30 PM', home: 'Circuit of the Americas', away: 'COTA', channel: 'FOX', startTime: '15:30', endTime: '20:00', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-03-08', time: '3:30 PM', home: 'Phoenix', away: '', channel: 'FS1', startTime: '15:30', endTime: '20:00', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-03-15', time: '4:00 PM', home: 'Las Vegas', away: '', channel: 'FS1', startTime: '16:00', endTime: '20:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-03-22', time: '3:00 PM', home: 'Darlington', away: '', channel: 'FS1', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-03-29', time: '3:30 PM', home: 'Martinsville', away: '', channel: 'FS1', startTime: '15:30', endTime: '20:00', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-04-12', time: '3:00 PM', home: 'Bristol', away: '', channel: 'FS1', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-04-19', time: '2:00 PM', home: 'Kansas', away: '', channel: 'FOX', startTime: '14:00', endTime: '18:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-04-26', time: '3:00 PM', home: 'Talladega', away: '', channel: 'FOX', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-05-03', time: '3:30 PM', home: 'Texas', away: '', channel: 'FS1', startTime: '15:30', endTime: '20:00', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-05-10', time: '3:00 PM', home: 'Watkins Glen', away: '', channel: 'FS1', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-05-17', time: '3:00 PM', home: 'All Star Race', away: 'Dover', channel: 'FS1', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-05-24', time: '6:00 PM', home: 'Charlotte', away: '', channel: 'Prime Video', startTime: '18:00', endTime: '22:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-05-31', time: '7:00 PM', home: 'Nashville', away: '', channel: 'Prime Video', startTime: '19:00', endTime: '23:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-06-07', time: '3:00 PM', home: 'Michigan', away: '', channel: 'Prime Video', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-06-14', time: '3:00 PM', home: 'Pocono', away: '', channel: 'Prime Video', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-06-28', time: '3:30 PM', home: 'Sonoma', away: 'Sonoma Raceway', channel: 'TNT', startTime: '15:30', endTime: '20:00', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-07-05', time: '6:00 PM', home: 'Chicago', away: '', channel: 'TNT', startTime: '18:00', endTime: '22:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-07-12', time: '7:00 PM', home: 'Atlanta', away: '', channel: 'TNT', startTime: '19:00', endTime: '23:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-07-19', time: '7:00 PM', home: 'North Wilkesboro', away: '', channel: 'TNT', startTime: '19:00', endTime: '23:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-07-26', time: '2:00 PM', home: 'Indianapolis', away: '', channel: 'TNT', startTime: '14:00', endTime: '18:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-08-09', time: '3:30 PM', home: 'Iowa', away: '', channel: 'USA Net', startTime: '15:30', endTime: '20:00', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-08-15', time: '7:00 PM', home: 'Richmond', away: '', channel: 'USA Net', startTime: '19:00', endTime: '23:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-08-23', time: '3:00 PM', home: 'New Hampshire', away: '', channel: 'USA Net', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-08-29', time: '7:30 PM', home: 'Daytona', away: '', channel: 'NBC', startTime: '19:30', endTime: '23:59', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-09-06', time: '5:00 PM', home: 'Darlington', away: 'Playoffs', channel: 'USA Net', startTime: '17:00', endTime: '21:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-09-13', time: '3:00 PM', home: 'WWT', away: 'Playoffs', channel: 'USA Net', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-09-19', time: '7:30 PM', home: 'Bristol', away: 'Playoffs', channel: 'USA Net', startTime: '19:30', endTime: '23:59', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-09-27', time: '3:00 PM', home: 'Kansas', away: 'Playoffs', channel: 'USA Net', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-10-04', time: '5:30 PM', home: 'Las Vegas', away: 'Playoffs', channel: 'USA Net', startTime: '17:30', endTime: '22:00', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-10-11', time: '3:00 PM', home: 'Charlotte Road Course', away: 'Playoffs', channel: 'USA Net', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-10-18', time: '3:00 PM', home: 'Phoenix', away: 'Playoffs', channel: 'USA Net', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-10-25', time: '2:00 PM', home: 'Talladega', away: 'Playoffs', channel: 'NBC', startTime: '14:00', endTime: '18:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-11-01', time: '2:00 PM', home: 'Martinsville', away: 'Playoffs', channel: 'NBC', startTime: '14:00', endTime: '18:30', url: 'https://www.nascar.com/followlive/' },
  { date: '2026-11-08', time: '3:00 PM', home: 'Miami', away: 'Championship', channel: 'NBC', startTime: '15:00', endTime: '19:30', url: 'https://www.nascar.com/followlive/' },
],

'USWNT': [
{ date: '2026-01-27', time: '10:00 pm', startTime: '22:00', endTime: '23:59', away: 'Chile', home: 'United States', channel: 'TBS', url: 'https://www.fotmob.com/matches/usa-vs-chile/4yz4r48f#5135650' },

{ date: '2026-03-01', time: '5:00 pm', startTime: '17:00', endTime: '19:00', away: 'Argentina', home: 'United States', channel: 'TNT', url: 'https://www.fotmob.com/matches/usa-vs-argentina/1hyjta0#5135654' },

{ date: '2026-03-04', time: '6:30 pm', startTime: '18:30', endTime: '20:30', away: 'Canada', home: 'United States', channel: 'TNT', url: 'https://www.fotmob.com/matches/usa-vs-canada/1hyp09u#5135656' },

{ date: '2026-03-07', time: '3:30 pm', startTime: '15:30', endTime: '17:30', away: 'Colombia', home: 'United States', channel: 'TBS', url: 'https://www.fotmob.com/matches/usa-vs-colombia/duxxf56#5135658' },

{ date: '2026-04-11', time: '5:30 pm', startTime: '17:30', endTime: '19:30', away: 'Japan', home: 'United States', channel: 'TNT', url: 'https://www.fotmob.com/teams/5909/fixtures/usa' },

{ date: '2026-04-14', time: '10:00 pm', startTime: '22:00', endTime: '23:59', away: 'Japan', home: 'United States', channel: 'TNT', url: 'https://www.fotmob.com/teams/5909/fixtures/usa' },

{ date: '2026-04-17', time: '9:00 pm', startTime: '21:00', endTime: '23:00', away: 'Japan', home: 'United States', channel: 'TNT', url: 'https://www.fotmob.com/teams/5909/fixtures/usa' },
],

'IMSASportsCar': [
  { date: '2026-01-25', time: '1:00 am', startTime: '1:00', endTime: '14:00', away: '24 Hours of', home: 'Daytona', channel: 'Peacock, NBC', url: 'https://www.imsa.com/scoring/' }, // Add IMSA SportsCar Championship races here
  // Example format:
  // { date: '2026-01-24', time: '1:00 PM', startTime: '13:00', endTime: '18:00', home: 'Rolex 24 at Daytona', away: 'Daytona', channel: 'NBC', url: 'https://www.imsa.com/events/...' },
],

           

        // Add more leagues here as needed: Boxing, UFC, PGATour, LPGATour, PGATourChampions, NASCARCupSeries, DPWorldTour, LIVGolf, IMSASportsCar
    };


     // ----- New: Load games from Firestore and render list with URL inputs -----
     document.getElementById('loadGamesBtn').addEventListener('click', async () => {
         const btn = document.getElementById('loadGamesBtn');
         btn.disabled = true; btn.textContent = 'Loading...';
         try {
             await ensureFirebase();
             const db = firebase.firestore();
            
             // Get selected date
             const selectedDate = getSelectedDate();
             const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
             const isFutureDate = selectedDate > todayStr;


             // Query appropriate collection based on date
             let games = [];
             if (isFutureDate) {
                 // Future date: query sportsGamesFuture
                 const futureGamesRef = db.collection('sportsGamesFuture');
                 const snapshot = await futureGamesRef.where('gameDate', '==', selectedDate).orderBy('Start Time').get();
                 games = snapshot.empty ? [] : snapshot.docs.map(d => d.data());
             } else {
                 // Today: query sportsGames
                 const gamesRef = db.collection('artifacts/flashlive-daily-scraper/public/data/sportsGames');
                 const snapshot = await gamesRef.where('gameDate', '==', selectedDate).orderBy('Start Time').get();
                 games = snapshot.empty ? [] : snapshot.docs.map(d => d.data());
             }
            
            // Add hardcoded games from Hardcoded_Today_Schedules
            const leaguesWithHardcodedToday = ['Boxing', 'UFC', 'PGATour', 'LPGATour', 'Tennis', 'PGATourChampions', 'NASCARCupSeries', 'DPWorldTour', 'LIVGolf', 'IMSASportsCar', 'CFB'];
            const leagueDisplayNameMap = {
                'Boxing': 'Boxing',
                'UFC': 'UFC',
                'PGATour': 'PGA Tour',
                'LPGATour': 'LPGA Tour',
                'Tennis': 'Tennis',
                'PGATourChampions': 'PGA Champions',
                'NASCARCupSeries': 'NASCAR Cup Series',
                'DPWorldTour': 'DP World Tour',
                'LIVGolf': 'LIV Golf',
                'IMSASportsCar': 'IMSA SportsCar',
                'CFB': 'CFB'
            };
            
             leaguesWithHardcodedToday.forEach((leagueKey, leagueIndex) => {
                 const leagueDisplayName = leagueDisplayNameMap[leagueKey] || leagueKey;
                
                 if (Hardcoded_Today_Schedules[leagueKey]) {
                     const todayGames = Hardcoded_Today_Schedules[leagueKey].filter(game => game.date === selectedDate);
                    
                     todayGames.forEach((game, gameIndex) => {
                         // Create Game ID: hardcoded-{leagueKey}-{date}-{index}
                         const gameId = `hardcoded-${leagueKey}-${game.date}-${gameIndex}`;
                        
                         // Convert startTime string (e.g., '19:00') to a Date object
                         let startTimeDate = null;
                         if (game.startTime && game.date) {
                             try {
                                 // Parse date (YYYY-MM-DD) and startTime (HH:MM)
                                 const [year, month, day] = game.date.split('-').map(Number);
                                 const [hours, minutes] = game.startTime.split(':').map(Number);
                                 startTimeDate = new Date(year, month - 1, day, hours, minutes || 0);
                             } catch (e) {
                                 console.warn('Failed to parse startTime for hardcoded game:', game, e);
                             }
                         }
                        
                         // Convert to same format as regular games
                         games.push({
                             'Game ID': gameId,
                             'Away Team': game.away,
                             'Home Team': game.home,
                             'League': leagueDisplayName,
                             'Sport': leagueKey === 'Tennis' ? 'Tennis' : (leagueKey === 'CFB' ? 'American Football' : (leagueKey.includes('Golf') ? 'Golf' : (leagueKey.includes('PGA') ? 'Golf' : (leagueKey === 'Boxing' || leagueKey === 'UFC' ? 'Combat' : 'Racing')))),
                             'Match Status': 'SCHEDULED',
                             'gameDate': game.date,
                             'channel': game.channel || '',
                             'Channel': game.channel || '',
                             'hardcodedTodayUrl': game.url || '',
                             'isHardcoded': true, // Flag to identify hardcoded games
                             'Start Time': startTimeDate, // Use parsed Date object, or null if not available
                             'hardcodedTime': game.time || '' // Store original time string as fallback
                         });
                     });
                 }
             });




              // Load featured games to check which ones are already featured and get header text
              const featuredRef = db.collection('artifacts/flashlive-daily-scraper/public/data/Featured');
              const featuredSnapshot = await featuredRef.where('gameDate', '==', selectedDate).get();
              const featuredGameIds = new Set();
              const featuredGameData = new Map(); // Map of gameId -> {headerText, applyToAllLeague}
              const leagueImportanceMap = new Map(); // Map of league -> leagueImportance
              featuredSnapshot.forEach(doc => {
                  const data = doc.data();
                  const gameId = data['Game ID'] || data.gameId;
                  const league = data.League || data.league;
                  if (gameId) {
                      featuredGameIds.add(String(gameId));
                      featuredGameData.set(String(gameId), {
                          headerText: data.headerText || data['Header Text'] || '',
                          applyToAllLeague: data.applyToAllLeague || data['Apply To All League'] || false
                      });
                  }
                  // Track league importance (use first non-null value found for each league)
                  if (league && !leagueImportanceMap.has(league)) {
                      const importance = data.leagueImportance !== null && data.leagueImportance !== undefined
                          ? data.leagueImportance
                          : (data['League Importance'] !== null && data['League Importance'] !== undefined ? data['League Importance'] : null);
                      if (importance !== null) {
                          leagueImportanceMap.set(league, Number(importance));
                      }
                  }
              });




              renderGamesList(games, featuredGameIds, selectedDate, featuredGameData, leagueImportanceMap);
          } catch (err) {
              console.error('Error loading games:', err);
              alert('Failed to load games: ' + err.message);
          } finally {
              btn.disabled = false; btn.textContent = 'Load games';
          }
      });




      function renderGamesList(games, featuredGameIds = new Set(), gameDate = null, featuredGameData = new Map(), leagueImportanceMap = new Map()) {
          const container = document.getElementById('gamesList');
          container.innerHTML = '';
          if (!games || games.length === 0) {
              container.innerHTML = '<div class="info">No games found for today.</div>';
              return;
          }




          // If gameDate not provided, compute today's date
          if (!gameDate) {
              gameDate = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
          }




          // Group games by league
          const byLeague = {};
          games.forEach(game => {
              const league = game.League || game.league || 'Unknown League';
              if (!byLeague[league]) byLeague[league] = [];
              byLeague[league].push(game);
          });




          const leagueNames = Object.keys(byLeague).sort();




          leagueNames.forEach(league => {
              const section = document.createElement('div');
              section.style.marginBottom = '18px';




              const header = document.createElement('div');
              header.style.display = 'flex';
              header.style.alignItems = 'baseline';
              header.style.justifyContent = 'space-between';
              header.style.marginBottom = '8px';




              const title = document.createElement('div');
              title.innerHTML = `<strong style="font-size:15px">${escapeHtml(league)}</strong>`;
              header.appendChild(title);




              const headerRight = document.createElement('div');
              headerRight.style.display = 'flex';
              headerRight.style.alignItems = 'center';
              headerRight.style.gap = '12px';


              // League importance input
              const importanceWrap = document.createElement('div');
              importanceWrap.style.display = 'flex';
              importanceWrap.style.alignItems = 'center';
              importanceWrap.style.gap = '6px';
             
              const importanceLabel = document.createElement('label');
              importanceLabel.textContent = 'League importance:';
              importanceLabel.style.fontSize = '12px';
              importanceLabel.style.color = '#9aa';
              importanceLabel.style.marginBottom = '0';
             
              const importanceInput = document.createElement('input');
              importanceInput.type = 'number';
              importanceInput.min = '1';
              importanceInput.max = '99';
              importanceInput.placeholder = '1-99';
              importanceInput.style.width = '60px';
              importanceInput.style.padding = '4px 6px';
              importanceInput.style.background = '#1a1a1a';
              importanceInput.style.border = '1px solid #333';
              importanceInput.style.borderRadius = '4px';
              importanceInput.style.color = '#e0e0e0';
              importanceInput.style.fontSize = '12px';
              const currentImportance = leagueImportanceMap.get(league);
              if (currentImportance !== undefined && currentImportance !== null) {
                  importanceInput.value = String(currentImportance);
              }
             
             // Save league importance when changed (debounced)
             let importanceTimeout = null;
             let isSavingImportance = false;
             const saveLeagueImportance = async () => {
                 clearTimeout(importanceTimeout);
                 importanceTimeout = setTimeout(async () => {
                     if (isSavingImportance) return; // Prevent concurrent saves
                     isSavingImportance = true;
                    
                     const importanceValue = importanceInput.value.trim();
                     const importanceNum = importanceValue === '' ? null : Number(importanceValue);
                    
                     if (importanceValue !== '' && (isNaN(importanceNum) || importanceNum < 1 || importanceNum > 99)) {
                         alert('League importance must be a number between 1 and 99');
                         importanceInput.value = currentImportance !== undefined && currentImportance !== null ? String(currentImportance) : '';
                         isSavingImportance = false;
                         return;
                     }
                    
                     // Visual feedback: show saving state
                     const originalBorder = importanceInput.style.border;
                     importanceInput.style.border = '1px solid #4a9eff';
                    
                     try {
                         const response = await fetch(`${FUNCTION_URL}/perspectives/updateLeagueImportance`, {
                             method: 'POST',
                             headers: {
                                 'Content-Type': 'application/json'
                             },
                             body: JSON.stringify({
                                 league: league,
                                 gameDate: gameDate,
                                 leagueImportance: importanceNum
                             })
                         });
                        
                         if (!response.ok) {
                             const data = await response.json().catch(() => ({ error: 'Unknown error' }));
                             throw new Error(data.error || data.details || `HTTP ${response.status}`);
                         }
                        
                         const data = await response.json();
                         console.log(`Updated league importance for ${league}:`, data);
                        
                         // Update the map for future renders
                         if (importanceNum !== null) {
                             leagueImportanceMap.set(league, importanceNum);
                         } else {
                             leagueImportanceMap.delete(league);
                         }
                        
                         // Success: briefly show green border
                         importanceInput.style.border = '1px solid #4ade80';
                         setTimeout(() => {
                             importanceInput.style.border = originalBorder;
                         }, 500);
                     } catch (err) {
                         console.error('Error saving league importance:', err);
                         alert('Error saving league importance: ' + err.message);
                         importanceInput.value = currentImportance !== undefined && currentImportance !== null ? String(currentImportance) : '';
                         // Error: show red border
                         importanceInput.style.border = '1px solid #f87171';
                         setTimeout(() => {
                             importanceInput.style.border = originalBorder;
                         }, 2000);
                     } finally {
                         isSavingImportance = false;
                     }
                 }, 500); // Debounce 500ms
             };
             
              importanceInput.addEventListener('blur', saveLeagueImportance);
              importanceInput.addEventListener('keypress', (e) => {
                  if (e.key === 'Enter') {
                      importanceInput.blur();
                  }
              });
             
              importanceWrap.appendChild(importanceLabel);
              importanceWrap.appendChild(importanceInput);
              headerRight.appendChild(importanceWrap);


              const count = document.createElement('div');
              count.style.color = '#9aa';
              count.style.fontSize = '13px';
              count.textContent = `${byLeague[league].length} game${byLeague[league].length !== 1 ? 's' : ''}`;
              headerRight.appendChild(count);
             
              header.appendChild(headerRight);




              section.appendChild(header);




              // divider
              const hr = document.createElement('div');
              hr.style.height = '1px';
              hr.style.background = '#222';
              hr.style.margin = '6px 0 12px 0';
              section.appendChild(hr);




              // Column headers row
              const headerRow = document.createElement('div');
              headerRow.style.display = 'grid';
              headerRow.style.gridTemplateColumns = '60px 1fr 200px 80px 420px 120px';
              headerRow.style.gap = '8px';
              headerRow.style.alignItems = 'center';
              headerRow.style.marginBottom = '8px';
              headerRow.style.paddingBottom = '8px';
              headerRow.style.borderBottom = '1px solid #333';
            
              const featuredHeader = document.createElement('div');
              featuredHeader.style.fontSize = '12px';
              featuredHeader.style.fontWeight = '600';
              featuredHeader.style.color = '#9aa';
              featuredHeader.textContent = 'Featured';
            
              const gameInfoHeader = document.createElement('div');
              gameInfoHeader.style.fontSize = '12px';
              gameInfoHeader.style.fontWeight = '600';
              gameInfoHeader.style.color = '#9aa';
              gameInfoHeader.textContent = 'Game';
            
              const headerTextHeader = document.createElement('div');
              headerTextHeader.style.fontSize = '12px';
              headerTextHeader.style.fontWeight = '600';
              headerTextHeader.style.color = '#9aa';
              headerTextHeader.textContent = 'Header Text';
            
              const applyToAllHeader = document.createElement('div');
              applyToAllHeader.style.fontSize = '12px';
              applyToAllHeader.style.fontWeight = '600';
              applyToAllHeader.style.color = '#9aa';
              applyToAllHeader.textContent = 'All League';
            
              const urlHeader = document.createElement('div');
              urlHeader.style.fontSize = '12px';
              urlHeader.style.fontWeight = '600';
              urlHeader.style.color = '#9aa';
              urlHeader.textContent = 'Social URL';
            
              const actionHeader = document.createElement('div');
              actionHeader.style.fontSize = '12px';
              actionHeader.style.fontWeight = '600';
              actionHeader.style.color = '#9aa';
              actionHeader.textContent = 'Action';
            
              headerRow.appendChild(featuredHeader);
              headerRow.appendChild(gameInfoHeader);
              headerRow.appendChild(headerTextHeader);
              headerRow.appendChild(applyToAllHeader);
              headerRow.appendChild(urlHeader);
              headerRow.appendChild(actionHeader);
              section.appendChild(headerRow);




              // games list for league
              byLeague[league].forEach(game => {
                  const row = document.createElement('div');
                  row.style.display = 'grid';
                  row.style.gridTemplateColumns = '60px 1fr 200px 80px 420px 120px';
                  row.style.gap = '8px';
                  row.style.alignItems = 'center';
                  row.style.marginBottom = '8px';




                  const gameId = String(game['Game ID'] || game.gameId || 'NO-ID');
                  const isFeatured = featuredGameIds.has(gameId);
                  const gameData = featuredGameData.get(gameId) || { headerText: '', applyToAllLeague: false };




                  // Featured checkbox
                  const featuredWrap = document.createElement('div');
                  const featuredCheckbox = document.createElement('input');
                  featuredCheckbox.type = 'checkbox';
                  featuredCheckbox.checked = isFeatured;
                  featuredCheckbox.style.cursor = 'pointer';
                  featuredCheckbox.style.width = '18px';
                  featuredCheckbox.style.height = '18px';
                  featuredWrap.appendChild(featuredCheckbox);
                  featuredWrap.style.display = 'flex';
                  featuredWrap.style.justifyContent = 'center';




                  const gameInfo = document.createElement('div');
                  let startTime = '';
                  if (game['Start Time']) {
                      // Handle Firestore Timestamp or Date object
                      if (game['Start Time'].toDate) {
                          startTime = game['Start Time'].toDate().toLocaleString();
                      } else if (game['Start Time'] instanceof Date) {
                          startTime = game['Start Time'].toLocaleString();
                      } else {
                          startTime = new Date(game['Start Time']).toLocaleString();
                      }
                  } else if (game.isHardcoded && game.hardcodedTime) {
                      // Fallback to hardcoded time string for hardcoded games
                      startTime = game.hardcodedTime;
                  }
                  const isHardcoded = game.isHardcoded === true;
                  const hardcodedLabel = isHardcoded ? '<span style="color:#ffa500;font-size:11px;font-weight:600;">[Hardcoded]</span> ' : '';
                  gameInfo.innerHTML = `<div style="font-size:13px;color:#9aa">${hardcodedLabel}<code style="color:#cfc">${escapeHtml(String(gameId))}</code></div><div style="margin-top:6px"><strong>${escapeHtml(game['Away Team'] || '')}</strong> @ <strong>${escapeHtml(game['Home Team'] || '')}</strong></div><div style="margin-top:6px;font-size:12px;color:#b0b0b0">${escapeHtml(startTime || 'No start time')}</div>`;




                  // Header Text input and checkbox
                  const headerTextWrap = document.createElement('div');
                  headerTextWrap.style.display = 'flex';
                  headerTextWrap.style.flexDirection = 'column';
                  headerTextWrap.style.gap = '4px';
                
                  const headerTextInput = document.createElement('input');
                  headerTextInput.type = 'text';
                  headerTextInput.placeholder = 'Header text (optional)';
                  headerTextInput.value = gameData.headerText || '';
                  headerTextInput.style.width = '100%';
                  headerTextInput.style.padding = '6px';
                  headerTextInput.style.background = '#1a1a1a';
                  headerTextInput.style.border = '1px solid #333';
                  headerTextInput.style.borderRadius = '4px';
                  headerTextInput.style.color = '#e0e0e0';
                  headerTextInput.style.fontSize = '12px';
                  headerTextInput.disabled = !isFeatured; // Only enable if featured
                
                  const applyToAllWrap = document.createElement('div');
                  applyToAllWrap.style.display = 'flex';
                  applyToAllWrap.style.alignItems = 'center';
                  applyToAllWrap.style.gap = '4px';
                
                  const applyToAllCheckbox = document.createElement('input');
                  applyToAllCheckbox.type = 'checkbox';
                  applyToAllCheckbox.checked = gameData.applyToAllLeague || false;
                  applyToAllCheckbox.disabled = !isFeatured; // Only enable if featured
                  applyToAllCheckbox.style.cursor = isFeatured ? 'pointer' : 'not-allowed';
                  applyToAllCheckbox.style.width = '14px';
                  applyToAllCheckbox.style.height = '14px';
                
                  const applyToAllLabel = document.createElement('label');
                  applyToAllLabel.textContent = 'All';
                  applyToAllLabel.style.fontSize = '11px';
                  applyToAllLabel.style.color = isFeatured ? '#b0b0b0' : '#666';
                  applyToAllLabel.style.cursor = isFeatured ? 'pointer' : 'not-allowed';
                
                  applyToAllWrap.appendChild(applyToAllCheckbox);
                  applyToAllWrap.appendChild(applyToAllLabel);
                  headerTextWrap.appendChild(headerTextInput);
                  headerTextWrap.appendChild(applyToAllWrap);
                
                 // Save header text when it changes (debounced)
                 let headerTextTimeout = null;
                 let isSavingHeader = false;
                 const saveHeaderText = async () => {
                     // Check current checkbox state, not the closure variable
                     if (!featuredCheckbox.checked) return;
                    
                     clearTimeout(headerTextTimeout);
                     headerTextTimeout = setTimeout(async () => {
                         if (isSavingHeader) return; // Prevent concurrent saves
                         isSavingHeader = true;
                        
                         // Visual feedback: show saving state
                         const originalBorder = headerTextInput.style.border;
                         headerTextInput.style.border = '1px solid #4a9eff';
                        
                         try {
                             const response = await fetch(`${FUNCTION_URL}/perspectives/updateFeaturedHeader`, {
                                 method: 'POST',
                                 headers: {
                                     'Content-Type': 'application/json'
                                 },
                                 body: JSON.stringify({
                                     gameId: gameId,
                                     gameDate: gameDate,
                                     headerText: headerTextInput.value.trim(),
                                     applyToAllLeague: applyToAllCheckbox.checked
                                 })
                             });
                            
                             if (!response.ok) {
                                 const data = await response.json().catch(() => ({ error: 'Unknown error' }));
                                 console.error('Error saving header text:', data.error || data.details);
                                 headerTextInput.style.border = '1px solid #f87171'; // Red on error
                                 setTimeout(() => {
                                     headerTextInput.style.border = originalBorder;
                                 }, 2000);
                             } else {
                                 // Success: briefly show green border
                                 headerTextInput.style.border = '1px solid #4ade80';
                                 setTimeout(() => {
                                     headerTextInput.style.border = originalBorder;
                                 }, 500);
                             }
                         } catch (err) {
                             console.error('Error saving header text:', err);
                             headerTextInput.style.border = '1px solid #f87171'; // Red on error
                             setTimeout(() => {
                                 headerTextInput.style.border = originalBorder;
                             }, 2000);
                         } finally {
                             isSavingHeader = false;
                         }
                     }, 500); // Debounce 500ms
                 };
                
                 headerTextInput.addEventListener('input', saveHeaderText);
                 applyToAllCheckbox.addEventListener('change', saveHeaderText);
                
                  // Store reference to update enabled state when featured checkbox changes
                  const updateHeaderTextEnabled = () => {
                      const isNowFeatured = featuredCheckbox.checked;
                      headerTextInput.disabled = !isNowFeatured;
                      applyToAllCheckbox.disabled = !isNowFeatured;
                      applyToAllLabel.style.color = isNowFeatured ? '#b0b0b0' : '#666';
                      applyToAllLabel.style.cursor = isNowFeatured ? 'pointer' : 'not-allowed';
                  };
                
                  // Wrap the featured checkbox change handler
                  const originalHandler = featuredCheckbox.onchange;
                  featuredCheckbox.onchange = null; // Clear to avoid conflicts
                  featuredCheckbox.addEventListener('change', async function() {
                      updateHeaderTextEnabled();
                      // Call original handler logic inline
                      await (async () => {
                          featuredCheckbox.disabled = true;
                          try {
                              const response = await fetch(`${FUNCTION_URL}/perspectives/toggleFeatured`, {
                                  method: 'POST',
                                  headers: {
                                      'Content-Type': 'application/json'
                                  },
                                  body: JSON.stringify({
                                      gameId: gameId,
                                      gameDate: gameDate,
                                      featured: featuredCheckbox.checked
                                  })
                              });




                              let data;
                              try {
                                  data = await response.json();
                              } catch (jsonError) {
                                  const text = await response.text();
                                  throw new Error(`Server returned non-JSON: ${text.substring(0, 200)}`);
                              }




                             if (response.ok) {
                                 if (featuredCheckbox.checked) {
                                     featuredGameIds.add(gameId);
                                     // If header text was already entered, save it now
                                     if (headerTextInput.value.trim()) {
                                         saveHeaderText();
                                     }
                                 } else {
                                     featuredGameIds.delete(gameId);
                                     // Clear header text when unfeatured
                                     headerTextInput.value = '';
                                     applyToAllCheckbox.checked = false;
                                 }
                             } else {
                                 throw new Error(data.error || data.details || `HTTP ${response.status}: ${response.statusText}`);
                             }
                          } catch (err) {
                              console.error('Error updating featured status:', err);
                              let errorMsg = err.message;
                            
                              if (err.message.includes('Failed to fetch') || err.message.includes('Load failed')) {
                                  errorMsg = `Network error: Could not reach Cloud Function. Make sure the function is deployed with the new /perspectives/toggleFeatured endpoint. Details: ${err.message}`;
                              }
                            
                              alert('Error updating featured status: ' + errorMsg);
                              featuredCheckbox.checked = !featuredCheckbox.checked; // Revert checkbox
                              updateHeaderTextEnabled();
                          } finally {
                              featuredCheckbox.disabled = false;
                          }
                      })();
                  });
                
                  updateHeaderTextEnabled(); // Set initial state




                  const inputWrap = document.createElement('div');
                  const input = document.createElement('input');
                  input.type = 'text';
                  input.placeholder = 'Paste social URL here';
                  input.style.width = '100%';
                  inputWrap.appendChild(input);




                  const btnWrap = document.createElement('div');
                  const addBtn = document.createElement('button');
                  addBtn.type = 'button';
                  addBtn.textContent = 'Add';
                  addBtn.addEventListener('click', async () => {
                      addBtn.disabled = true;
                      try {
                          const url = input.value.trim();
                          if (!url) { alert('Please paste a social URL'); return; }
                          const payload = {
                              gameId: String(game['Game ID'] || game.gameId),
                              url: url,
                              priority: 50,
                              sourceType: 'fan',
                              addedBy: 'admin'
                          };




                          const resp = await fetch(`${FUNCTION_URL}/perspectives/addManualPost`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify(payload)
                          });
                          const data = await (resp.headers.get('content-type')?.includes('application/json') ? resp.json() : resp.text());
                          if (!resp.ok) throw new Error(typeof data === 'string' ? data : (data.error || JSON.stringify(data)));
                          alert('Added post to game ' + payload.gameId);
                          input.value = '';
                      } catch (err) {
                          console.error(err);
                          alert('Error adding post: ' + err.message);
                      } finally {
                          addBtn.disabled = false;
                      }
                  });
                  btnWrap.appendChild(addBtn);




                  row.appendChild(featuredWrap);
                  row.appendChild(gameInfo);
                  row.appendChild(headerTextWrap);
                  row.appendChild(inputWrap);
                  row.appendChild(btnWrap);
                  section.appendChild(row);
              });




              container.appendChild(section);
          });
      }




      function escapeHtml(s) {
          if (!s) return '';
          return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }




      // ----- Parse pasted output from list-games-simple.cjs -----
      document.getElementById('loadPastedBtn').addEventListener('click', async () => {
          const text = document.getElementById('pasteList').value || '';
          if (!text.trim()) { alert('Paste the script output first'); return; }
          const parsed = parsePastedList(text);
          if (!parsed || parsed.length === 0) { alert('No games parsed from pasted text'); return; }
        
          // Load featured games to check which ones are already featured
          try {
              await ensureFirebase();
              const db = firebase.firestore();
              const selectedDate = getSelectedDate();
              const featuredRef = db.collection('artifacts/flashlive-daily-scraper/public/data/Featured');
              const featuredSnapshot = await featuredRef.where('gameDate', '==', selectedDate).get();
              const featuredGameIds = new Set();
              const featuredGameData = new Map();
              const leagueImportanceMap = new Map();
              featuredSnapshot.forEach(doc => {
                  const data = doc.data();
                  const gameId = data['Game ID'] || data.gameId;
                  const league = data.League || data.league;
                  if (gameId) {
                      featuredGameIds.add(String(gameId));
                      featuredGameData.set(String(gameId), {
                          headerText: data.headerText || data['Header Text'] || '',
                          applyToAllLeague: data.applyToAllLeague || data['Apply To All League'] || false
                      });
                  }
                  // Track league importance (use first non-null value found for each league)
                  if (league && !leagueImportanceMap.has(league)) {
                      const importance = data.leagueImportance !== null && data.leagueImportance !== undefined
                          ? data.leagueImportance
                          : (data['League Importance'] !== null && data['League Importance'] !== undefined ? data['League Importance'] : null);
                      if (importance !== null) {
                          leagueImportanceMap.set(league, Number(importance));
                      }
                  }
              });
              renderGamesList(parsed, featuredGameIds, selectedDate, featuredGameData, leagueImportanceMap);
          } catch (err) {
              console.error('Error loading featured status:', err);
              // Still render the list even if we can't load featured status
              renderGamesList(parsed, new Set(), null, new Map(), new Map());
          }
      });




      function parsePastedList(text) {
          const lines = text.split(/\r?\n/).map(l => l.trimRight());
          const games = [];
          let currentLeague = '';
          const gameLineRe = /^\s*(\S+)\s+(.+?)\s+vs\s+(.+?)(?:\s+\(([^)]*)\))?\s*\[.*\]$/i;
          for (const raw of lines) {
              const line = raw.trim();
              if (!line) continue;
              if (/^-{3,}$/.test(line)) continue; // divider
              // league header likely has no 'vs' and not starting with id
              if (!line.includes(' vs ')) {
                  // treat as league header
                  currentLeague = line;
                  continue;
              }
              const m = line.match(gameLineRe);
              if (m) {
                  const gameId = m[1];
                  const away = m[2].trim();
                  const home = m[3].trim();
                  const timeOrScore = m[4] || '';
                  // Build minimal game objects compatible with renderer
                  games.push({
                      'Game ID': gameId,
                      'Away Team': away,
                      'Home Team': home,
                      'Start Time': timeOrScore || '',
                      'League': currentLeague || ''
                  });
              } else {
                  // fallback: try splitting by multiple spaces, take first token as id
                  const parts = line.split(/\s{2,}/);
                  if (parts.length >= 2 && parts[0].includes('-')) {
                      const id = parts[0].trim();
                      const teams = parts[1];
                      const vsIdx = teams.indexOf(' vs ');
                      if (vsIdx !== -1) {
                          const away = teams.slice(0, vsIdx).trim();
                          const home = teams.slice(vsIdx + 4).trim();
                          games.push({ 'Game ID': id, 'Away Team': away, 'Home Team': home, 'Start Time': '', 'League': currentLeague || '' });
                      }
                  }
              }
          }
          return games;
      }
  </script>
</body>
</html>
