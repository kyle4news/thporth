<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daily To-Do List</title>
  <style>
    body {
      background-color: #f8f2eb;
      font-family: "Helvetica Neue", sans-serif;
      color: black;
      margin: 0;
      padding: 2rem;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    #countdown-section {
      margin-bottom: 1rem;
    }

    #countdown-section input[type="time"] {
      width: 150px;
      margin-right: 0.5rem;
      margin-bottom: 0;
      display: inline-block;
    }

    #countdown-section button {
      margin-left: 0;
    }

    #countdown {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }

    #time-back {
      font-size: 1rem;
      margin-bottom: 1rem;
      color: #666;
    }

    #input-section {
      margin-bottom: 1rem;
    }

    input[type="text"] {
      padding: 0.5rem;
      width: 300px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    input[type="time"] {
      padding: 0.5rem;
      width: 150px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-left: 0.5rem;
    }

    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      margin-left: 0.5rem;
      cursor: pointer;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .todo-content {
      margin-left: 0.5rem;
      flex-grow: 1;
      display: flex;
      align-items: center;
    }

    .todo-text {
      margin-right: 0.5rem;
    }

    .deadline-info {
      font-size: 0.9rem;
      color: #666;
      white-space: nowrap;
    }

    .done .todo-text {
      color: gray;
      text-decoration: line-through;
    }

    input[type="checkbox"] {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid black;
      border-radius: 2px;
      display: inline-block;
      position: relative;
      cursor: pointer;
    }

    input[type="checkbox"]:checked::after {
      content: "âœ”";
      position: absolute;
      top: -2px;
      left: 2px;
      font-size: 14px;
      color: black;
    }
  </style>
</head>
<body>

  <h1>Today's To-Do List</h1>
  <div id="countdown-section">
    <input type="time" id="end-time-input" placeholder="End time" />
    <button onclick="setEndTime()">Set End Time</button>
  </div>
  <div id="countdown">Time left today: --:--:--</div>
  <div id="time-back">Time you get back: 0 minutes</div>

  <div id="input-section">
    <input type="text" id="todo-input" placeholder="Add a new task..." />
    <input type="time" id="deadline-input" placeholder="Deadline" />
    <button onclick="addTodo()">Add</button>
  </div>

  <ul id="todo-list"></ul>

  <script>
    // Global variables
    let totalTimeBack = parseInt(localStorage.getItem('timeBack')) || 0;
    let deadlineTimers = new Map();
    let endTime = localStorage.getItem('endTime');
    let countdownInterval = null;

    // Load saved end time
    function loadEndTime() {
      if (endTime) {
        document.getElementById('end-time-input').value = endTime;
        setEndTime();
      }
    }

    // Set end time and start countdown
    function setEndTime() {
      const endTimeInput = document.getElementById('end-time-input').value;
      if (!endTimeInput) return;
      
      endTime = endTimeInput;
      localStorage.setItem('endTime', endTime);
      
      // Hide input section and show countdown
      document.getElementById('countdown-section').style.display = 'none';
      
      // Start countdown timer
      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = setInterval(updateCountdown, 1000);
      updateCountdown();
    }

    // Countdown timer
    function updateCountdown() {
      if (!endTime) return;
      
      const now = new Date();
      const [hours, minutes] = endTime.split(':');
      const endTimeDate = new Date();
      endTimeDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);

      const diff = endTimeDate - now;

      if (diff > 0) {
        const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
        const minutesLeft = Math.floor((diff / (1000 * 60)) % 60);
        const secondsLeft = Math.floor((diff / 1000) % 60);

        // Format time remaining
        let timeRemaining = '';
        if (hoursLeft > 0) {
          timeRemaining = `${hoursLeft} hour${hoursLeft !== 1 ? 's' : ''} ${minutesLeft} minute${minutesLeft !== 1 ? 's' : ''} and ${secondsLeft} second${secondsLeft !== 1 ? 's' : ''}`;
        } else {
          timeRemaining = `${minutesLeft} minute${minutesLeft !== 1 ? 's' : ''} and ${secondsLeft} second${secondsLeft !== 1 ? 's' : ''}`;
        }

        // Format deadline time for display
        const endTimeDisplay = new Date();
        endTimeDisplay.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        const deadlineTimeStr = endTimeDisplay.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});

        document.getElementById('countdown').textContent = `${timeRemaining} until ${deadlineTimeStr}`;
      } else {
        clearListAtEndTime();
      }
      
      document.getElementById('time-back').textContent = `Time you get back: ${totalTimeBack} minutes`;
    }

    function clearListAtEndTime() {
      document.getElementById('todo-list').innerHTML = '';
      localStorage.removeItem('todos');
      localStorage.removeItem('timeBack');
      localStorage.removeItem('endTime');
      totalTimeBack = 0;
      endTime = null;
      deadlineTimers.clear();
      
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      
      // Reset to input mode
      document.getElementById('countdown-section').style.display = 'block';
      document.getElementById('end-time-input').value = '';
      document.getElementById('countdown').textContent = 'Time left today: --:--:--';
    }

    // To-Do list logic
    const todoList = document.getElementById('todo-list');
    const todoInput = document.getElementById('todo-input');
    const deadlineInput = document.getElementById('deadline-input');

    function loadTodos() {
      const saved = JSON.parse(localStorage.getItem('todos')) || [];
      saved.forEach(item => {
        createTodoElement(item.text, item.deadline, item.done, item.timeBack || 0);
      });
    }

    function saveTodos() {
      const items = Array.from(todoList.children).map(li => ({
        text: li.querySelector('.todo-text').textContent,
        deadline: li.dataset.deadline,
        done: li.classList.contains('done'),
        timeBack: parseInt(li.dataset.timeBack) || 0
      }));
      localStorage.setItem('todos', JSON.stringify(items));
      localStorage.setItem('timeBack', totalTimeBack.toString());
    }

    function addTodo() {
      const text = todoInput.value.trim();
      const deadline = deadlineInput.value;
      
      if (text !== '' && deadline !== '') {
        createTodoElement(text, deadline, false, 0);
        todoInput.value = '';
        deadlineInput.value = '';
        saveTodos();
      }
    }

    function updateTaskDeadlineCountdown(li, deadline) {
      if (!deadline || !li.querySelector('.deadline-info')) return;
      
      const deadlineTime = new Date();
      const [hours, minutes] = deadline.split(':');
      
      if (!hours || !minutes) return;
      
      deadlineTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

      const now = new Date();
      const diff = deadlineTime - now;

      if (diff > 0) {
        const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
        const minutesLeft = Math.floor((diff / (1000 * 60)) % 60);
        const secondsLeft = Math.floor((diff / 1000) % 60);
        
        let timeLeftText = '';
        if (hoursLeft > 0) {
          timeLeftText = `${hoursLeft}h ${minutesLeft}m ${secondsLeft}s`;
        } else {
          timeLeftText = `${minutesLeft}m ${secondsLeft}s`;
        }
        
        li.querySelector('.deadline-info').textContent = `Deadline: ${deadline} (${timeLeftText} left)`;
        li.dataset.timeLeft = Math.floor(diff / (1000 * 60));
      } else {
        li.querySelector('.deadline-info').textContent = `Deadline: ${deadline} (OVERDUE)`;
        li.dataset.timeLeft = 0;
      }
    }

    function createTodoElement(text, deadline, done, timeBack) {
      const li = document.createElement('li');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';

      const todoContent = document.createElement('div');
      todoContent.className = 'todo-content';

      const span = document.createElement('span');
      span.className = 'todo-text';
      span.textContent = text;

      const deadlineSpan = document.createElement('span');
      deadlineSpan.className = 'deadline-info';

      li.dataset.deadline = deadline;
      li.dataset.timeBack = timeBack;

      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          // Calculate time saved
          const timeLeft = parseInt(li.dataset.timeLeft) || 0;
          if (timeLeft > 0) {
            totalTimeBack += timeLeft;
            li.dataset.timeBack = (parseInt(li.dataset.timeBack) + timeLeft).toString();
            document.getElementById('time-back').textContent = `Time you get back: ${totalTimeBack} minutes`;
            localStorage.setItem('timeBack', totalTimeBack.toString());
          }
          
          // Clear the timer for this task
          if (deadlineTimers.has(li)) {
            clearInterval(deadlineTimers.get(li));
            deadlineTimers.delete(li);
          }
          
          li.classList.add('done');
          todoList.appendChild(li); // Move to bottom
          saveTodos();
        }
      });

      todoContent.appendChild(span);
      todoContent.appendChild(deadlineSpan);
      li.appendChild(checkbox);
      li.appendChild(todoContent);

      // Update deadline countdown
      updateTaskDeadlineCountdown(li, deadline);

      // Set up timer for this task's deadline countdown
      const timer = setInterval(() => {
        if (!li.classList.contains('done')) {
          updateTaskDeadlineCountdown(li, deadline);
        }
      }, 1000); // Update every second
      
      deadlineTimers.set(li, timer);

      if (done) {
        li.classList.add('done');
        checkbox.checked = true;
        todoList.appendChild(li);
        clearInterval(timer);
      } else {
        todoList.insertBefore(li, todoList.firstChild);
      }
    }

    loadTodos();
    loadEndTime();
  </script>

</body>
</html>
